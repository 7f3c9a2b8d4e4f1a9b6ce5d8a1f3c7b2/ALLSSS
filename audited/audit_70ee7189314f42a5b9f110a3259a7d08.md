### Title
Byzantine Fault Tolerance Violation in LIB Calculation Due to Insufficient Index Formula

### Summary
The Last Irreversible Block (LIB) calculation algorithm uses the index formula `(Count-1)/3` which fails to maintain 2/3 Byzantine fault tolerance when only the minimum required miners participate. When exactly `MinersCountOfConsent` miners mine in a round, Byzantine miners controlling up to 1/3 of total miners can disproportionately influence the selected LIB height, potentially setting it to a value that lacks true 2/3 supermajority consensus, compromising chain finality guarantees.

### Finding Description

The vulnerability exists in the `Deconstruct()` method of the `LastIrreversibleBlockHeightCalculator` class: [1](#0-0) 

The algorithm requires at least `MinersCountOfConsent` miners to participate: [2](#0-1) 

**Root Cause:**

The index formula `(Count-1)/3` at line 32 selects a height such that approximately 70% of **participating miners** have reported heights greater than or equal to the selected LIB. However, when exactly `MinersCountOfConsent = floor(2N/3) + 1` miners participate (the minimum threshold), this only ensures agreement from approximately 50% of **total miners**, which violates the 2/3 Byzantine fault tolerance requirement.

Mathematical analysis for N=10 total miners:
- `MinersCountOfConsent = floor(20/3) + 1 = 7` miners required
- If exactly 7 mine (3 Byzantine + 4 honest in worst case)
- Index = `(7-1)/3 = 2`
- Miners with heights ≥ selected LIB = `7 - 2 = 5`
- Agreement: 5 out of 10 total miners = **50%**, NOT ≥67% required for BFT

For N=7 total miners:
- `MinersCountOfConsent = floor(14/3) + 1 = 5` miners required
- If exactly 5 mine (2 Byzantine + 3 honest in worst case)
- Index = `(5-1)/3 = 1`
- Miners with heights ≥ selected LIB = `5 - 1 = 4`
- Agreement: 4 out of 7 total miners = **57%**, NOT ≥67% required for BFT

**Why Existing Protections Fail:**

The `MinersCountOfConsent` check at line 26 ensures sufficient miner participation, but the index formula doesn't account for the concentration of Byzantine miners among participants. When participant count drops to the minimum threshold and all Byzantine miners participate, their proportion among participants (≤43%) exceeds the global 1/3 bound, allowing them to influence which height is selected from the sorted array. [3](#0-2) 

The `ImpliedIrreversibleBlockHeight` is set to the block height each miner produces: [4](#0-3) 

While miners cannot arbitrarily manipulate this value, Byzantine miners can produce blocks strategically to report lower heights relative to honest miners, especially when combined with selective participation timing.

### Impact Explanation

**Consensus Safety Violation:**
- The LIB (Last Irreversible Block) determines chain finality - blocks below this height cannot be reverted
- If LIB is set without true 2/3 consensus, it violates the fundamental safety property of Byzantine fault tolerant consensus
- Byzantine miners can cause the chain to mark blocks as irreversible prematurely when less than 2/3 of all miners have confirmed them

**Concrete Harm:**
- **Finality Compromise**: Blocks marked as irreversible may not have sufficient consensus backing, risking chain reorganization if honest miners later reject them
- **Cross-Chain Impact**: The LIB height is used for cross-chain indexing and verification; an incorrectly calculated LIB could allow invalid cross-chain transfers to be finalized prematurely
- **Economic Impact**: Transactions depending on finality guarantees (e.g., large transfers, DEX settlements) may be reversed if the LIB calculation is manipulated

**Affected Parties:**
- All network participants relying on finality guarantees
- Cross-chain bridge users whose transfers depend on LIB confirmation
- DApps and exchanges treating LIB blocks as immutable

**Severity Justification:**
Critical severity because it undermines the core consensus safety invariant that blocks below LIB are irreversibly finalized with 2/3+ agreement.

### Likelihood Explanation

**Attacker Capabilities Required:**
- Control up to floor(N/3) miners (standard Byzantine assumption)
- Ability to coordinate participation timing among Byzantine miners
- No additional privileges or contract vulnerabilities needed

**Attack Complexity:**
- Medium complexity - requires coordinating Byzantine miners to participate when honest miner participation is low
- Does not require breaking cryptography or exploiting software bugs
- Relies on natural network conditions (some honest miners offline)

**Feasibility Conditions:**
1. **Natural Occurrence**: Some honest miners being offline/missing time slots due to network issues, maintenance, or operational problems is common in distributed systems
2. **Participant Count**: When participation drops to exactly `MinersCountOfConsent` (happens during network degradation)
3. **Strategic Timing**: Byzantine miners can observe network conditions and choose to participate actively when honest participation is low

**Detection Constraints:**
- The manipulation is subtle - the calculated LIB appears valid according to the algorithm
- No obvious on-chain indicators that the LIB lacks true 2/3 consensus
- Byzantine behavior (selective participation) is indistinguishable from legitimate operational patterns

**Probability Assessment:**
- Network conditions causing reduced honest miner participation: **Moderate to High** (typical in production blockchain networks)
- Byzantine miners timing their participation strategically: **High** (no technical barriers)
- Combined probability: **Moderate** - will occur periodically during network stress or miner outages

### Recommendation

**Code-Level Mitigation:**

Modify the index formula in `AEDPoSContract_LIB.cs` line 32 to ensure the selected LIB has agreement from at least `ceil(2N/3)` of **total miners** (not just participating miners):

```csharp
// Calculate index to ensure ceil(2N/3) total miners have heights >= LIB
var requiredConsensus = _currentRound.RealTimeMinersInformation.Count.Mul(2).Div(3);
if (_currentRound.RealTimeMinersInformation.Count.Mod(3) != 0) requiredConsensus = requiredConsensus.Add(1);
var indexOffset = impliedIrreversibleHeights.Count.Sub(requiredConsensus);
if (indexOffset < 0)
{
    libHeight = 0;
    return;
}
libHeight = impliedIrreversibleHeights[indexOffset];
```

This ensures the selected height is agreed upon by at least `ceil(2N/3)` miners, maintaining proper Byzantine fault tolerance.

**Invariant Checks:**
- Add assertion: `(impliedIrreversibleHeights.Count - selectedIndex) >= ceil(2N/3)`
- Add logging to monitor when LIB calculation occurs with exactly MinersCountOfConsent participants
- Add metrics tracking the percentage of total miners agreeing with each LIB selection

**Test Cases:**
1. Test with exactly MinersCountOfConsent miners mining, all Byzantine miners at low heights
2. Test with N=10, K=7 scenario showing current formula fails 2/3 requirement
3. Test edge cases with different miner counts (7, 10, 13, 16, etc.)
4. Verify corrected formula maintains 2/3 consensus in all scenarios

### Proof of Concept

**Initial State:**
- Blockchain configured with N=10 miners in AEDPoS consensus
- Current round at round number 100
- Blockchain height approximately at 1000

**Round N-1 (Round 99) Block Production:**
- All 10 miners successfully mine in round 99
- 3 Byzantine miners produce blocks early in the round at heights: 990, 991, 992
- 7 honest miners produce blocks at heights: 993, 994, 995, 996, 997, 998, 999
- Each miner's `ImpliedIrreversibleBlockHeight` is set to their production height

**Round N (Round 100) Participation:**
- Only 7 miners mine in round 100 (exactly `MinersCountOfConsent`)
- The 3 Byzantine miners all participate
- Only 4 of the 7 honest miners participate (3 are offline due to network issues)
- Miners who mine: Byzantine1, Byzantine2, Byzantine3, Honest1, Honest2, Honest3, Honest4

**LIB Calculation Execution:**
- `GetMinedMiners()` returns 7 miners who mined in round 100
- `GetSortedImpliedIrreversibleBlockHeights()` retrieves heights from round 99: `[990, 991, 992, 993, 994, 995, 996]`
- Count check: `7 >= 7` (passes `MinersCountOfConsent` threshold)
- Index calculation: `(7-1)/3 = 6/3 = 2`
- **Selected LIB: `heights[2] = 992`**

**Expected vs Actual Result:**

**Expected (Correct BFT):** LIB should require at least `ceil(2*10/3) = 7` miners to have heights ≥ selected value. With only 5 miners having heights ≥ 992 (including the Byzantine miner at 992), this should fail the 2/3 requirement, and LIB should either be set lower or return 0.

**Actual (Vulnerable):** LIB is set to 992, which was reported by a Byzantine miner. Only 5 out of 10 total miners (50%) have confirmed blocks at height ≥ 992, violating the 2/3 consensus requirement.

**Success Condition:** Byzantine miners successfully influenced the LIB calculation to select a height (992) that lacks true supermajority consensus, demonstrating the Byzantine fault tolerance violation.

### Citations

**File:** contract/AElf.Contracts.Consensus.AEDPoS/AEDPoSContract_LIB.cs (L20-33)
```csharp
        public void Deconstruct(out long libHeight)
        {
            if (_currentRound.IsEmpty || _previousRound.IsEmpty) libHeight = 0;

            var minedMiners = _currentRound.GetMinedMiners().Select(m => m.Pubkey).ToList();
            var impliedIrreversibleHeights = _previousRound.GetSortedImpliedIrreversibleBlockHeights(minedMiners);
            if (impliedIrreversibleHeights.Count < _currentRound.MinersCountOfConsent)
            {
                libHeight = 0;
                return;
            }

            libHeight = impliedIrreversibleHeights[impliedIrreversibleHeights.Count.Sub(1).Div(3)];
        }
```

**File:** contract/AElf.Contracts.Consensus.AEDPoS/Types/Round_ImpliedIrreversibleBlockHeight.cs (L10-10)
```csharp
    public int MinersCountOfConsent => RealTimeMinersInformation.Count.Mul(2).Div(3).Add(1);
```

**File:** contract/AElf.Contracts.Consensus.AEDPoS/AEDPoSContract_GetConsensusBlockExtraData.cs (L118-118)
```csharp
        updatedRound.RealTimeMinersInformation[pubkey].ImpliedIrreversibleBlockHeight = Context.CurrentHeight;
```
