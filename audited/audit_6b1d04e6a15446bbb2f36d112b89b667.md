### Title
Emergency Organization Cannot Update Compromised Profit Receivers Without Disrupting Consensus

### Summary
The `SetProfitsReceiver()` function in the Election contract restricts authorization to only the Treasury contract, preventing the emergency response organization from updating profit receivers in emergency scenarios. This forces the emergency organization to choose between allowing continued subsidy reward loss to a compromised address or removing an otherwise functional node from consensus.

### Finding Description

The `SetProfitsReceiver()` function enforces a strict authorization check that only allows the Treasury contract to call it: [1](#0-0) 

This contrasts with other maintenance functions that grant the emergency organization override capabilities. For example, `UpdateCandidateInformation()` allows either the consensus contract OR the emergency organization: [2](#0-1) 

Similarly, `RemoveEvilNode()` grants the emergency organization the power to remove candidates entirely: [3](#0-2) 

The normal flow for updating profit receivers requires the candidate admin to call `TreasuryContract.SetProfitsReceiver()`: [4](#0-3) 

The Treasury contract then calls the Election contract's `SetProfitsReceiver()` to update the beneficiary in the subsidy profit scheme: [5](#0-4) 

The Election contract removes the old beneficiary and adds the new one to receive subsidy rewards: [6](#0-5) 

When an evil node is removed, the beneficiary is automatically removed: [7](#0-6) 

### Impact Explanation

If a candidate's profit receiver address is compromised (private key stolen or leaked) while the node itself remains functional:

1. **Direct Fund Loss**: The attacker can claim subsidy rewards from the SubsidyHash profit scheme each term, draining funds intended for the legitimate candidate.

2. **Forced Operational Trade-off**: The emergency organization faces two undesirable options:
   - Allow continued reward loss to the compromised address (ongoing financial damage)
   - Remove the entire candidate via `RemoveEvilNode()` even though the node is functioning properly (unnecessary consensus disruption)

3. **Inconsistent Emergency Powers**: The emergency organization can update other critical candidate information but lacks granular control over profit receiver updates, creating an operational gap in emergency response capabilities.

4. **Reliance on Potentially Compromised Admin**: If the candidate admin is unresponsive, compromised, or has lost access, there is no emergency mechanism to protect the subsidy funds while maintaining consensus stability.

### Likelihood Explanation

This vulnerability becomes exploitable under the following realistic conditions:

1. **Compromised Profit Receiver**: A candidate's profit receiver private key is compromised separately from their node operator key (common when using separate addresses for fund management vs node operations).

2. **Unresponsive Admin**: The candidate admin (obtained via `GetCandidateAdmin()`) is unavailable, unresponsive, or has lost access credentials. [8](#0-7) 

3. **Attack Window**: Each term where the issue persists, the attacker claims subsidy rewards that should go to the legitimate candidate.

4. **Detection**: The compromise would be detected when subsidy rewards are claimed by an unauthorized address, but response options are limited by this authorization gap.

The likelihood is medium because it requires specific conditions (separate key compromise + admin unavailability), but these conditions are realistic in production environments where operational security and key management involve multiple parties.

### Recommendation

**Modify the authorization check** in `ElectionContract.SetProfitsReceiver()` to allow the emergency response organization as an additional authorized caller:

```csharp
public override Empty SetProfitsReceiver(SetProfitsReceiverInput input)
{
    Assert(
        Context.GetContractAddressByName(SmartContractConstants.TreasuryContractSystemName) == Context.Sender ||
        Context.Sender == GetEmergencyResponseOrganizationAddress(),
        "No permission.");
    // ... rest of implementation
}
```

This change:
1. Maintains normal operational flow through Treasury contract and candidate admin
2. Provides emergency override capability consistent with `UpdateCandidateInformation()`
3. Allows granular emergency response without forcing consensus disruption
4. Preserves the high threshold requirements of the emergency organization (90% approval)

**Add test cases** to verify:
- Emergency organization can update profit receiver in emergency scenarios
- Normal candidate admin flow still works
- Updated beneficiary correctly receives subsidy rewards
- Authorization is properly enforced for unauthorized callers

### Proof of Concept

**Initial State:**
1. Candidate "CandidateA" has announced election with admin address AdminOrg
2. CandidateA has set profit receiver to ReceiverAddress1 via Treasury contract
3. CandidateA is in DataCentersRankingList and receiving subsidy rewards
4. Emergency response organization has been created

**Attack Sequence:**
1. ReceiverAddress1 private key is compromised and controlled by Attacker
2. Each term, Attacker claims subsidy rewards intended for CandidateA
3. CandidateA's admin (AdminOrg) is unresponsive due to operational issues
4. Emergency organization attempts to call `ElectionContract.SetProfitsReceiver()` to update receiver to safe address
5. **Expected Result**: Emergency organization can update profit receiver to protect funds
6. **Actual Result**: Transaction fails with "No permission." assertion

**Impact Demonstration:**
- Without fix: Emergency org must choose between removing entire node (consensus impact) or accepting continued loss
- With fix: Emergency org can update profit receiver to safe address, preserving both consensus and fund security

**Notes**

The authorization restriction in `SetProfitsReceiver()` creates an inconsistency with the broader emergency governance pattern established in the Election contract. While the emergency organization can handle critical candidate maintenance operations like removing evil nodes and updating candidate information, it lacks the ability to perform targeted profit receiver updates. This gap forces unnecessarily disruptive emergency responses and creates a vulnerability window where compromised profit receivers can drain subsidy rewards when normal administrative channels are unavailable.

### Citations

**File:** contract/AElf.Contracts.Election/ElectionContract_Maintainence.cs (L85-88)
```csharp
        Assert(
            Context.GetContractAddressByName(SmartContractConstants.ConsensusContractSystemName) ==
            Context.Sender || Context.Sender == GetEmergencyResponseOrganizationAddress(),
            "Only consensus contract can update candidate information.");
```

**File:** contract/AElf.Contracts.Election/ElectionContract_Maintainence.cs (L111-111)
```csharp
            RemoveBeneficiary(input.Pubkey);
```

**File:** contract/AElf.Contracts.Election/ElectionContract_Maintainence.cs (L338-338)
```csharp
        Assert(Context.Sender == GetEmergencyResponseOrganizationAddress(), "No permission.");
```

**File:** contract/AElf.Contracts.Election/ElectionContract_Maintainence.cs (L381-383)
```csharp
        Assert(
            Context.GetContractAddressByName(SmartContractConstants.TreasuryContractSystemName) == Context.Sender,
            "No permission.");
```

**File:** contract/AElf.Contracts.Election/ElectionContract_Maintainence.cs (L394-395)
```csharp
        RemoveBeneficiary(input.CandidatePubkey,beneficiaryAddress);
        AddBeneficiary(input.CandidatePubkey,input.ReceiverAddress);
```

**File:** contract/AElf.Contracts.Treasury/TreasuryContract.cs (L608-609)
```csharp
        var admin = State.ElectionContract.GetCandidateAdmin.Call(new StringValue {Value = input.Pubkey});
        Assert(Context.Sender == admin , "No permission.");
```

**File:** contract/AElf.Contracts.Treasury/TreasuryContract.cs (L621-626)
```csharp
        State.ElectionContract.SetProfitsReceiver.Send(new AElf.Contracts.Election.SetProfitsReceiverInput
        {
            CandidatePubkey = input.Pubkey,
            ReceiverAddress = input.ProfitsReceiverAddress,
            PreviousReceiverAddress = previousProfitsReceiver ?? new Address()
        });
```

**File:** contract/AElf.Contracts.Election/ViewMethods.cs (L411-414)
```csharp
    public override Address GetCandidateAdmin(StringValue input)
    {
        return State.CandidateAdmins[State.InitialPubkeyMap[input.Value] ?? input.Value];
    }
```
