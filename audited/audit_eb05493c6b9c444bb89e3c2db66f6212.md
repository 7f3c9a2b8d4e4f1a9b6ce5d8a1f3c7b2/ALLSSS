### Title
Integer Overflow in Association Organization Threshold Validation Bypasses Governance Controls

### Summary
The `CreateOrganization` function validates threshold values by performing unchecked addition operations that can overflow, allowing creation of organizations with functionally invalid thresholds. When `MaximalAbstentionThreshold` or `MaximalRejectionThreshold` are set to values near `long.MaxValue`, adding them to `MinimalApprovalThreshold` causes integer overflow to negative values, which incorrectly pass validation checks. This enables attackers to create governance organizations where abstention and rejection votes become meaningless, requiring only minimal approvals to execute any proposal.

### Finding Description

The vulnerability exists in the organization validation logic. The `CreateOrganization` function calls `Validate(organization)` to verify threshold parameters. [1](#0-0) 

The validation performs arithmetic addition of threshold values without overflow protection: [2](#0-1) 

The threshold fields are defined as `int64` (C# `long`) types in the protobuf schema: [3](#0-2) 

**Root Cause**: In C#, integer arithmetic is unchecked by default. When two `long` values are added and the result exceeds `long.MaxValue` (9,223,372,036,854,775,807), the value wraps to a large negative number. The validation checks at lines 77-80 perform:
- `MaximalAbstentionThreshold + MinimalApprovalThreshold <= organizationMemberCount`
- `MaximalRejectionThreshold + MinimalApprovalThreshold <= organizationMemberCount`

If an attacker provides `MaximalAbstentionThreshold = 9223372036854775807` and `MinimalApprovalThreshold = 1`, the addition overflows to `-9223372036854775808`, which is less than any positive member count, causing the validation to pass incorrectly.

**Why Protections Fail**: The codebase contains no `checked` arithmetic contexts or upper bound validation on threshold values before the addition operations. The validation only checks that thresholds are non-negative, not that they are reasonable relative to member count before performing arithmetic.

### Impact Explanation

**Governance Bypass**: An attacker can create an Association organization with thresholds that effectively disable rejection and abstention voting mechanisms. During proposal release, the contract checks: [4](#0-3) 

With `MaximalAbstentionThreshold` and `MaximalRejectionThreshold` set to `long.MaxValue`:
- `IsProposalRejected` checks if `rejectionMemberCount > 9223372036854775807` - always false
- `IsProposalAbstained` checks if `abstentionMemberCount > 9223372036854775807` - always false
- Only `MinimalApprovalThreshold` (e.g., 1) approvals needed to release proposals

**Concrete Impact**:
- Any proposal can be released with minimal approvals, regardless of rejections/abstentions
- Multi-signature governance controls are completely bypassed
- Attackers can execute arbitrary contract calls through the organization's virtual address
- Affects any contracts or assets controlled by such organizations

**Severity Justification**: This is a Medium severity issue because it undermines the core governance mechanism of Association contracts, allowing unauthorized execution of proposals that should require proper consensus. While it requires creating a new organization (not compromising existing ones), any assets transferred to or controlled by such organizations are at risk.

### Likelihood Explanation

**Attack Complexity**: Trivial. The attack requires only:
1. Calling `CreateOrganization` with crafted threshold values
2. Standard transaction submission capability
3. No special privileges or pre-conditions

**Attacker Capabilities**: Any user can call `CreateOrganization` as it's a public method with no authorization checks. The malicious threshold values (e.g., `long.MaxValue`) are valid within the protobuf `int64` specification.

**Feasibility**: Extremely high. The exploit can be executed in a single transaction:
```
CreateOrganization({
  MinimalApprovalThreshold: 1,
  MinimalVoteThreshold: 1,
  MaximalAbstentionThreshold: 9223372036854775807,
  MaximalRejectionThreshold: 9223372036854775807,
  OrganizationMemberList: [attacker, accomplice1, ...],
  ProposerWhiteList: [attacker]
})
```

**Detection**: The malicious organization would have valid-looking threshold values in storage (large positive numbers), making detection difficult without analyzing the arithmetic overflow scenario. Users might unknowingly interact with or delegate authority to such organizations.

**Probability**: High for targeted attacks where an attacker wants to create a governance structure that appears legitimate but is actually under their unilateral control.

### Recommendation

**Immediate Fix**: Add explicit upper bound validation before arithmetic operations:

```csharp
private bool Validate(Organization organization)
{
    if (organization.ProposerWhiteList.Empty() ||
        organization.ProposerWhiteList.AnyDuplicate() ||
        organization.OrganizationMemberList.Empty() ||
        organization.OrganizationMemberList.AnyDuplicate())
        return false;
    if (organization.OrganizationAddress == null || organization.OrganizationHash == null)
        return false;
    var proposalReleaseThreshold = organization.ProposalReleaseThreshold;
    var organizationMemberCount = organization.OrganizationMemberList.Count();
    
    // Add upper bound checks before arithmetic
    if (proposalReleaseThreshold.MaximalAbstentionThreshold > organizationMemberCount ||
        proposalReleaseThreshold.MaximalRejectionThreshold > organizationMemberCount)
        return false;
        
    return proposalReleaseThreshold.MinimalVoteThreshold <= organizationMemberCount &&
           proposalReleaseThreshold.MinimalApprovalThreshold <= proposalReleaseThreshold.MinimalVoteThreshold &&
           proposalReleaseThreshold.MinimalApprovalThreshold > 0 &&
           proposalReleaseThreshold.MaximalAbstentionThreshold >= 0 &&
           proposalReleaseThreshold.MaximalRejectionThreshold >= 0 &&
           proposalReleaseThreshold.MaximalAbstentionThreshold +
           proposalReleaseThreshold.MinimalApprovalThreshold <= organizationMemberCount &&
           proposalReleaseThreshold.MaximalRejectionThreshold +
           proposalReleaseThreshold.MinimalApprovalThreshold <= organizationMemberCount;
}
```

**Invariant Checks**: Ensure that:
1. `MaximalAbstentionThreshold <= organizationMemberCount`
2. `MaximalRejectionThreshold <= organizationMemberCount`
3. These checks occur before any addition operations

**Test Cases**: Add regression tests for:
- Creating organization with `MaximalAbstentionThreshold = long.MaxValue`
- Creating organization with `MaximalRejectionThreshold = long.MaxValue`
- Creating organization with both thresholds near `long.MaxValue`
- Verify all cases fail validation with "Invalid organization" error

### Proof of Concept

**Initial State**: Standard AElf chain with deployed Association contract

**Transaction Steps**:
1. Call `CreateOrganization` with input:
   ```
   OrganizationMemberList: [Address1, Address2, Address3] (3 members)
   MinimalApprovalThreshold: 1
   MinimalVoteThreshold: 1
   MaximalAbstentionThreshold: 9223372036854775807
   MaximalRejectionThreshold: 9223372036854775807
   ProposerWhiteList: [Address1]
   ```

2. Observe organization creation succeeds (should fail but doesn't due to overflow)

3. Create proposal through the organization

4. Have Address2 and Address3 reject the proposal (2 rejections)

5. Have Address1 approve the proposal (1 approval)

6. Call `Release` on the proposal

**Expected Result**: Proposal should be blocked due to rejections exceeding `MaximalRejectionThreshold` relative to member count

**Actual Result**: Proposal releases successfully because `2 > 9223372036854775807` evaluates to `false`, and only 1 approval was needed. The governance mechanism is bypassed.

**Success Condition**: Organization is created with invalid thresholds that allow proposals to release despite majority rejection, demonstrating the governance bypass vulnerability.

### Citations

**File:** contract/AElf.Contracts.Association/Association.cs (L69-94)
```csharp
    public override Address CreateOrganization(CreateOrganizationInput input)
    {
        var organizationHashAddressPair = CalculateOrganizationHashAddressPair(input);
        var organizationAddress = organizationHashAddressPair.OrganizationAddress;
        var organizationHash = organizationHashAddressPair.OrganizationHash;
        var organization = new Organization
        {
            ProposalReleaseThreshold = input.ProposalReleaseThreshold,
            OrganizationAddress = organizationAddress,
            ProposerWhiteList = input.ProposerWhiteList,
            OrganizationMemberList = input.OrganizationMemberList,
            OrganizationHash = organizationHash,
            CreationToken = input.CreationToken
        };
        Assert(Validate(organization), "Invalid organization.");
        if (State.Organizations[organizationAddress] == null)
        {
            State.Organizations[organizationAddress] = organization;
            Context.Fire(new OrganizationCreated
            {
                OrganizationAddress = organizationAddress
            });
        }

        return organizationAddress;
    }
```

**File:** contract/AElf.Contracts.Association/Association_Helper.cs (L34-59)
```csharp
    private bool IsProposalRejected(ProposalInfo proposal, Organization organization)
    {
        var rejectionMemberCount =
            proposal.Rejections.Count(organization.OrganizationMemberList.Contains);
        return rejectionMemberCount > organization.ProposalReleaseThreshold.MaximalRejectionThreshold;
    }

    private bool IsProposalAbstained(ProposalInfo proposal, Organization organization)
    {
        var abstentionMemberCount = proposal.Abstentions.Count(organization.OrganizationMemberList.Contains);
        return abstentionMemberCount > organization.ProposalReleaseThreshold.MaximalAbstentionThreshold;
    }

    private bool CheckEnoughVoteAndApprovals(ProposalInfo proposal, Organization organization)
    {
        var approvedMemberCount = proposal.Approvals.Count(organization.OrganizationMemberList.Contains);
        var isApprovalEnough =
            approvedMemberCount >= organization.ProposalReleaseThreshold.MinimalApprovalThreshold;
        if (!isApprovalEnough)
            return false;

        var isVoteThresholdReached =
            proposal.Abstentions.Concat(proposal.Approvals).Concat(proposal.Rejections).Count() >=
            organization.ProposalReleaseThreshold.MinimalVoteThreshold;
        return isVoteThresholdReached;
    }
```

**File:** contract/AElf.Contracts.Association/Association_Helper.cs (L61-81)
```csharp
    private bool Validate(Organization organization)
    {
        if (organization.ProposerWhiteList.Empty() ||
            organization.ProposerWhiteList.AnyDuplicate() ||
            organization.OrganizationMemberList.Empty() ||
            organization.OrganizationMemberList.AnyDuplicate())
            return false;
        if (organization.OrganizationAddress == null || organization.OrganizationHash == null)
            return false;
        var proposalReleaseThreshold = organization.ProposalReleaseThreshold;
        var organizationMemberCount = organization.OrganizationMemberList.Count();
        return proposalReleaseThreshold.MinimalVoteThreshold <= organizationMemberCount &&
               proposalReleaseThreshold.MinimalApprovalThreshold <= proposalReleaseThreshold.MinimalVoteThreshold &&
               proposalReleaseThreshold.MinimalApprovalThreshold > 0 &&
               proposalReleaseThreshold.MaximalAbstentionThreshold >= 0 &&
               proposalReleaseThreshold.MaximalRejectionThreshold >= 0 &&
               proposalReleaseThreshold.MaximalAbstentionThreshold +
               proposalReleaseThreshold.MinimalApprovalThreshold <= organizationMemberCount &&
               proposalReleaseThreshold.MaximalRejectionThreshold +
               proposalReleaseThreshold.MinimalApprovalThreshold <= organizationMemberCount;
    }
```

**File:** protobuf/acs3.proto (L128-137)
```text
message ProposalReleaseThreshold {
    // The value for the minimum approval threshold.
    int64 minimal_approval_threshold = 1;
    // The value for the maximal rejection threshold.
    int64 maximal_rejection_threshold = 2;
    // The value for the maximal abstention threshold.
    int64 maximal_abstention_threshold = 3;
    // The value for the minimal vote threshold.
    int64 minimal_vote_threshold = 4;
}
```
