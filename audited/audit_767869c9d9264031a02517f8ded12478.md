### Title
Integer Overflow in Association Organization Threshold Validation Allows Bypass of Voting Safeguards

### Summary
The `Validate` function in the Association contract performs unchecked integer addition when validating threshold parameters, allowing extreme values (near `int64.MaxValue`) to cause overflow and bypass validation checks. This enables creation of organizations where proposals can never be blocked by abstentions or rejections, regardless of member votes, undermining the multi-signature governance model.

### Finding Description

**Location**: [1](#0-0) 

**Root Cause**: The validation logic performs unchecked addition of `MaximalAbstentionThreshold + MinimalApprovalThreshold` and `MaximalRejectionThreshold + MinimalApprovalThreshold`. In C#, integer arithmetic is unchecked by default, meaning overflow wraps around to negative values without raising an exception.

**Why Protections Fail**: When `MaximalAbstentionThreshold` is set to `int64.MaxValue` (9,223,372,036,854,775,807) and `MinimalApprovalThreshold` is set to 1, the addition overflows to `int64.MinValue` (-9,223,372,036,854,775,808). The validation check `(int64.MinValue) <= organizationMemberCount` always passes since member count is positive.

**Execution Path**:
1. Attacker calls `CreateOrganization` with malicious thresholds [2](#0-1) 
2. Validation is invoked at line 83 but passes due to overflow [3](#0-2) 
3. During proposal voting, the check `abstentionMemberCount > MaximalAbstentionThreshold` becomes `abstentionMemberCount > int64.MaxValue`, which can never be true [4](#0-3) 
4. Proposals can never be abstained regardless of member votes [5](#0-4) 

The threshold types are defined as `int64` in the protobuf specification [6](#0-5) , confirming the overflow potential.

### Impact Explanation

**Governance Compromise**: An organization with overflowed thresholds can execute arbitrary proposals with minimal approval (as low as 1 member) while completely ignoring abstentions or rejections from all other members. This breaks the fundamental multi-signature security model.

**Affected Parties**: 
- Any contract or resource that grants governance authority to such a misconfigured organization
- Organization members whose votes become meaningless
- The broader ecosystem if critical system contracts are controlled by compromised organizations

**Severity Justification**: If an organization with these malicious thresholds is granted authority over token contracts, Treasury, cross-chain management, or other critical components, it can execute unauthorized operations. The same vulnerability exists in `ChangeOrganizationThreshold` [7](#0-6) , though that requires passing a proposal first.

### Likelihood Explanation

**Attacker Capabilities**: Any user can call `CreateOrganization` without restrictions - there are no access controls on organization creation [2](#0-1) 

**Attack Complexity**: Low - attacker simply provides threshold values near `int64.MaxValue` in the `CreateOrganizationInput` structure.

**Feasibility**: Highly feasible. Example configuration that bypasses validation:
- `MinimalApprovalThreshold = 1`
- `MinimalVoteThreshold = 1`  
- `MaximalAbstentionThreshold = 9223372036854775807` (int64.MaxValue)
- `MaximalRejectionThreshold = 9223372036854775806`
- `OrganizationMemberList`: attacker-controlled addresses

**Detection Constraints**: The overflow is not obvious without examining the raw int64 values. Automated systems or users granting authority might not detect the malicious configuration. Test cases only validate normal overflow scenarios, not int64 boundary conditions [8](#0-7) 

### Recommendation

**Immediate Fix**: Add overflow checking to the validation logic. Replace unchecked addition with checked arithmetic:

```csharp
private bool Validate(Organization organization)
{
    // ... existing checks ...
    
    try
    {
        checked
        {
            var abstentionSum = proposalReleaseThreshold.MaximalAbstentionThreshold + 
                              proposalReleaseThreshold.MinimalApprovalThreshold;
            var rejectionSum = proposalReleaseThreshold.MaximalRejectionThreshold + 
                             proposalReleaseThreshold.MinimalApprovalThreshold;
            
            return abstentionSum <= organizationMemberCount &&
                   rejectionSum <= organizationMemberCount;
        }
    }
    catch (OverflowException)
    {
        return false;
    }
}
```

**Additional Validation**: Add explicit upper bounds checking:
- `MaximalAbstentionThreshold <= organizationMemberCount`
- `MaximalRejectionThreshold <= organizationMemberCount`

**Test Cases**: Add regression tests with int64 boundary values (int64.MaxValue, int64.MaxValue-1) to verify overflow is properly caught and rejected.

### Proof of Concept

**Initial State**: 
- Attacker prepares `CreateOrganizationInput` with 3 organization members

**Transaction Steps**:
1. Call `CreateOrganization` with:
   - `MinimalApprovalThreshold = 1`
   - `MinimalVoteThreshold = 1`
   - `MaximalAbstentionThreshold = 9223372036854775807` (int64.MaxValue)
   - `MaximalRejectionThreshold = 0`
   - `OrganizationMemberList`: [AttackerAddress1, AttackerAddress2, AttackerAddress3]
   - `ProposerWhiteList`: [AttackerAddress1]

2. Validation executes: `9223372036854775807 + 1` overflows to `-9223372036854775808`, which passes the check `-9223372036854775808 <= 3`

3. Organization is successfully created

4. Create proposal to the organization

5. One attacker address approves, two other addresses abstain

6. Despite 2/3 members abstaining, `IsProposalAbstained` check `2 > 9223372036854775807` returns false

7. Proposal passes with 1/3 approval and is releasable

**Expected Result**: Organization creation should fail with "Invalid organization."

**Actual Result**: Organization is created and proposals can be released with minimal approval despite majority opposition

**Success Condition**: Organization created with address returned, proposals bypass abstention/rejection safeguards completely

### Citations

**File:** contract/AElf.Contracts.Association/Association_Helper.cs (L24-32)
```csharp
    private bool IsReleaseThresholdReached(ProposalInfo proposal, Organization organization)
    {
        var isRejected = IsProposalRejected(proposal, organization);
        if (isRejected)
            return false;

        var isAbstained = IsProposalAbstained(proposal, organization);
        return !isAbstained && CheckEnoughVoteAndApprovals(proposal, organization);
    }
```

**File:** contract/AElf.Contracts.Association/Association_Helper.cs (L41-45)
```csharp
    private bool IsProposalAbstained(ProposalInfo proposal, Organization organization)
    {
        var abstentionMemberCount = proposal.Abstentions.Count(organization.OrganizationMemberList.Contains);
        return abstentionMemberCount > organization.ProposalReleaseThreshold.MaximalAbstentionThreshold;
    }
```

**File:** contract/AElf.Contracts.Association/Association_Helper.cs (L61-81)
```csharp
    private bool Validate(Organization organization)
    {
        if (organization.ProposerWhiteList.Empty() ||
            organization.ProposerWhiteList.AnyDuplicate() ||
            organization.OrganizationMemberList.Empty() ||
            organization.OrganizationMemberList.AnyDuplicate())
            return false;
        if (organization.OrganizationAddress == null || organization.OrganizationHash == null)
            return false;
        var proposalReleaseThreshold = organization.ProposalReleaseThreshold;
        var organizationMemberCount = organization.OrganizationMemberList.Count();
        return proposalReleaseThreshold.MinimalVoteThreshold <= organizationMemberCount &&
               proposalReleaseThreshold.MinimalApprovalThreshold <= proposalReleaseThreshold.MinimalVoteThreshold &&
               proposalReleaseThreshold.MinimalApprovalThreshold > 0 &&
               proposalReleaseThreshold.MaximalAbstentionThreshold >= 0 &&
               proposalReleaseThreshold.MaximalRejectionThreshold >= 0 &&
               proposalReleaseThreshold.MaximalAbstentionThreshold +
               proposalReleaseThreshold.MinimalApprovalThreshold <= organizationMemberCount &&
               proposalReleaseThreshold.MaximalRejectionThreshold +
               proposalReleaseThreshold.MinimalApprovalThreshold <= organizationMemberCount;
    }
```

**File:** contract/AElf.Contracts.Association/Association.cs (L69-94)
```csharp
    public override Address CreateOrganization(CreateOrganizationInput input)
    {
        var organizationHashAddressPair = CalculateOrganizationHashAddressPair(input);
        var organizationAddress = organizationHashAddressPair.OrganizationAddress;
        var organizationHash = organizationHashAddressPair.OrganizationHash;
        var organization = new Organization
        {
            ProposalReleaseThreshold = input.ProposalReleaseThreshold,
            OrganizationAddress = organizationAddress,
            ProposerWhiteList = input.ProposerWhiteList,
            OrganizationMemberList = input.OrganizationMemberList,
            OrganizationHash = organizationHash,
            CreationToken = input.CreationToken
        };
        Assert(Validate(organization), "Invalid organization.");
        if (State.Organizations[organizationAddress] == null)
        {
            State.Organizations[organizationAddress] = organization;
            Context.Fire(new OrganizationCreated
            {
                OrganizationAddress = organizationAddress
            });
        }

        return organizationAddress;
    }
```

**File:** contract/AElf.Contracts.Association/Association.cs (L203-216)
```csharp
    public override Empty ChangeOrganizationThreshold(ProposalReleaseThreshold input)
    {
        var organization = State.Organizations[Context.Sender];
        Assert(organization != null, "Organization not found.");
        organization.ProposalReleaseThreshold = input;
        Assert(Validate(organization), "Invalid organization.");
        State.Organizations[Context.Sender] = organization;
        Context.Fire(new OrganizationThresholdChanged
        {
            OrganizationAddress = Context.Sender,
            ProposerReleaseThreshold = input
        });
        return new Empty();
    }
```

**File:** protobuf/acs3.proto (L128-137)
```text
message ProposalReleaseThreshold {
    // The value for the minimum approval threshold.
    int64 minimal_approval_threshold = 1;
    // The value for the maximal rejection threshold.
    int64 maximal_rejection_threshold = 2;
    // The value for the maximal abstention threshold.
    int64 maximal_abstention_threshold = 3;
    // The value for the minimal vote threshold.
    int64 minimal_vote_threshold = 4;
}
```

**File:** test/AElf.Contracts.Association.Tests/AssociationContractTests.cs (L248-262)
```csharp
        //invalid maximalAbstentionThreshold
        {
            var minimalApproveThreshold = 1;
            var minimalVoteThreshold = 3;
            var maximalAbstentionThreshold = 4;
            var maximalRejectionThreshold = 0;

            var createOrganizationInput = GenerateCreateOrganizationInput(minimalApproveThreshold,
                minimalVoteThreshold,
                maximalAbstentionThreshold, maximalRejectionThreshold, Reviewer1);
            var transactionResult =
                await AssociationContractStub.CreateOrganization.SendWithExceptionAsync(createOrganizationInput);
            transactionResult.TransactionResult.Status.ShouldBe(TransactionResultStatus.Failed);
            transactionResult.TransactionResult.Error.Contains("Invalid organization.").ShouldBeTrue();
        }
```
