### Title
Missing Validation for Negative Resource Amounts Enables Resource Rental Reversal Attack

### Summary
The `InitializeFromParentChain` method lacks validation for negative `ResourceAmount` values, while non-exclusive side chains bypass CrossChain contract validation. This allows negative resource amounts to be set during side chain initialization, causing rental payment calculations to reverse - creators receive tokens instead of paying rental fees, draining the consensus contract.

### Finding Description

**Root Cause:** Inconsistent validation across initialization paths.

`State.ResourceAmount` is defined as `MappedState<string, int>` storing resource token amounts. [1](#0-0) 

The `InitializeFromParentChain` method sets resource amounts WITHOUT validating non-negativity: [2](#0-1) 

In contrast, `UpdateRentedResources` DOES validate: `Assert(pair.Value >= 0, "Invalid amount.");` [3](#0-2) 

**Why Protections Fail:**

The CrossChain contract only validates `InitialResourceAmount > 0` for exclusive side chains. For non-exclusive side chains, validation returns early: [4](#0-3) 

The validation itself requires positive values: [5](#0-4) 

However, `InitialResourceAmount` is passed to side chains for ALL types (both exclusive and non-exclusive): [6](#0-5) 

**Exploitation Path:**

When `PayRental` executes, it calculates rental using potentially negative `ResourceAmount`: [7](#0-6) 

With negative `State.ResourceAmount[symbol]`, the rental becomes negative. The balance check always passes for negative rental: [8](#0-7) 

This causes `ModifyBalance(creator, symbol, -donates)` to become `ModifyBalance(creator, symbol, POSITIVE_AMOUNT)`, adding tokens to the creator instead of deducting them.

Then the consensus contract loses tokens: [9](#0-8) 

### Impact Explanation

**Direct Fund Impact:**
- Side chain creators receive free resource tokens every rental period instead of paying fees
- Consensus contract loses tokens proportional to: `duration × |ResourceAmount| × Rental`
- With typical values (10 minutes, ResourceAmount=-100, Rental=1000), creator gains 1,000,000 tokens per period
- Breaks critical economic invariant: resource rental must flow FROM creator TO consensus

**Who is Affected:**
- Consensus contract loses funds
- Side chain creator gains unauthorized tokens
- Protocol economic model is compromised

**Severity Justification:** HIGH
- Enables direct token theft from consensus contract
- Breaks fundamental resource rental payment mechanism
- Allows unlimited token generation for attacker over time

### Likelihood Explanation

**Reachable Entry Point:**
`PayRental` is called by miners via `DonateResourceToken` on side chains: [10](#0-9) 

**Feasible Preconditions:**
1. Attacker creates a non-exclusive side chain with negative `InitialResourceAmount` values
2. CrossChain validation is bypassed for non-exclusive chains
3. `InitializeFromParentChain` lacks validation, allowing negative values to be set
4. No governance/parliament compromise required - only side chain creation capability

**Execution Practicality:**
- Attack executes automatically every rental period through normal mining operations
- No special transaction crafting needed after initialization
- Works under normal AElf contract execution model

**Economic Rationality:**
- Side chain creation cost is fixed
- Ongoing token theft accumulates unbounded over time
- Highly profitable for attacker

**Probability:** MEDIUM-HIGH
- Requires ability to create side chain (permitted operation)
- Could occur accidentally through initialization errors or intentionally
- No defense-in-depth protection exists in MultiToken contract

### Recommendation

**Exact Code-Level Mitigation:**

Add validation in `InitializeFromParentChain` after line 18 in TokenContract_Actions.cs:
```csharp
foreach (var pair in input.ResourceAmount)
{
    Assert(pair.Value >= 0, "Invalid resource amount.");
    State.ResourceAmount[pair.Key] = pair.Value;
}
```

**Additional Protections:**

1. Remove the early return for non-exclusive side chains in CrossChain contract validation, or extend validation to cover all side chain types [11](#0-10) 

2. Add invariant check in `PayRental` before rental calculation to fail fast if `ResourceAmount` is negative

**Test Cases:**

1. Test that `InitializeFromParentChain` rejects negative ResourceAmount values
2. Test that non-exclusive side chain creation rejects negative InitialResourceAmount
3. Test that `GetResourceUsage` returns only non-negative values
4. Regression test verifying rental payments flow in correct direction

### Proof of Concept

**Initial State:**
- Create non-exclusive side chain with `SideChainCreationRequest.InitialResourceAmount = { {"CPU", -100} }`
- Set `State.Rental["CPU"] = 1000` (1000 tokens per minute)
- Creator has 50,000 CPU tokens
- Consensus contract has 2,000,000 CPU tokens

**Execution Steps:**

1. CrossChain contract processes side chain creation
   - `IsPrivilegePreserved = false` (non-exclusive chain)
   - Validation returns early at line 125, skipping `AssertValidResourceTokenAmount`
   
2. `InitializeFromParentChain` called during chain initialization
   - `input.ResourceAmount["CPU"] = -100`
   - Line 19 sets `State.ResourceAmount["CPU"] = -100` without validation
   
3. Wait 10 minutes, miner calls `DonateResourceToken`
   - Triggers `PayRental()` at line 949
   
4. Rental calculation at line 1061:
   - `rental = 10 × (-100) × 1000 = -1,000,000`
   
5. Balance check at line 1062:
   - `50,000 >= -1,000,000` evaluates to TRUE
   
6. Line 1064: `donates = 0 + (-1,000,000) = -1,000,000`

7. Line 1065: `ModifyBalance(creator, "CPU", -(-1,000,000))`
   - Adds 1,000,000 CPU tokens to creator
   - Creator balance: 50,000 → 1,050,000
   
8. Line 1087: `ModifyBalance(consensusContractAddress, "CPU", -1,000,000)`
   - Deducts 1,000,000 CPU tokens from consensus
   - Consensus balance: 2,000,000 → 1,000,000

**Expected Result:** Creator pays 400,000 tokens (10 minutes × 100 ResourceAmount × 1000 Rental with positive value)

**Actual Result:** Creator receives 1,000,000 tokens; consensus contract loses 1,000,000 tokens

**Success Condition:** Creator balance increases by 1,000,000 instead of decreasing by 400,000 after rental period

### Citations

**File:** contract/AElf.Contracts.MultiToken/TokenContractState_ChargeFee.cs (L26-26)
```csharp
    public MappedState<string, int> ResourceAmount { get; set; }
```

**File:** contract/AElf.Contracts.MultiToken/TokenContract_Actions.cs (L19-19)
```csharp
        foreach (var pair in input.ResourceAmount) State.ResourceAmount[pair.Key] = pair.Value;
```

**File:** contract/AElf.Contracts.MultiToken/TokenContract_Fees.cs (L947-949)
```csharp
        if (!isMainChain)
        {
            PayRental();
```

**File:** contract/AElf.Contracts.MultiToken/TokenContract_Fees.cs (L1061-1061)
```csharp
            var rental = duration.Mul(State.ResourceAmount[symbol]).Mul(State.Rental[symbol]);
```

**File:** contract/AElf.Contracts.MultiToken/TokenContract_Fees.cs (L1062-1065)
```csharp
            if (availableBalance >= rental) // Success
            {
                donates = donates.Add(rental);
                ModifyBalance(creator, symbol, -donates);
```

**File:** contract/AElf.Contracts.MultiToken/TokenContract_Fees.cs (L1087-1087)
```csharp
            ModifyBalance(consensusContractAddress, symbol, donates);
```

**File:** contract/AElf.Contracts.MultiToken/TokenContract_Fees.cs (L1122-1122)
```csharp
            Assert(pair.Value >= 0, "Invalid amount.");
```

**File:** contract/AElf.Contracts.CrossChain/CrossChainContract_Helper.cs (L124-127)
```csharp
        if (!sideChainCreationRequest.IsPrivilegePreserved)
            return; // there is no restriction for non-exclusive side chain creation

        AssertValidResourceTokenAmount(sideChainCreationRequest);
```

**File:** contract/AElf.Contracts.CrossChain/CrossChainContract_Helper.cs (L143-143)
```csharp
            Assert(resourceTokenMap.ContainsKey(resourceTokenSymbol) && resourceTokenMap[resourceTokenSymbol] > 0,
```

**File:** contract/AElf.Contracts.CrossChain/CrossChainContract_Helper.cs (L541-541)
```csharp
            InitialResourceAmount = { sideChainCreationRequest.InitialResourceAmount }
```
