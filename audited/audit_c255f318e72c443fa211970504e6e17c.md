### Title
Inconsistent Vote Counting Allows MinimalVoteThreshold Bypass Through Stale Votes from Removed Members

### Summary
The Association contract's threshold calculation contains a critical inconsistency: approval/rejection/abstention counts filter votes by current membership, but the total vote count used for `MinimalVoteThreshold` validation does not. This allows proposals to pass using stale votes from members who were removed after voting, undermining the governance participation requirements.

### Finding Description

The vulnerability exists in the vote counting logic within `IsReleaseThresholdReached`. When a member votes via `Approve()`, their address is added to the proposal's approval list. [1](#0-0) 

Members can later be removed from the organization's member list through the `RemoveMember()` function, which removes them from `organization.OrganizationMemberList`. [2](#0-1) 

The root cause is an inconsistency in `CheckEnoughVoteAndApprovals()`:

1. **Approval counting (filtered)**: Uses `proposal.Approvals.Count(organization.OrganizationMemberList.Contains)` which only counts approvals from current members. [3](#0-2) 

2. **Total vote counting (NOT filtered)**: Uses `proposal.Abstentions.Concat(proposal.Approvals).Concat(proposal.Rejections).Count()` which counts ALL votes regardless of whether the voters are still organization members. [4](#0-3) 

The same filtering inconsistency exists for rejection and abstention counts, which also filter by current membership. [5](#0-4) 

This means votes from removed members:
- **Do NOT** count toward approval/rejection/abstention thresholds
- **DO** count toward the `MinimalVoteThreshold` requirement

### Impact Explanation

**Governance Manipulation**: Proposals can bypass the `MinimalVoteThreshold` requirement by leveraging stale votes from removed members. 

**Concrete Attack Scenario**:
- Organization with 10 members sets `MinimalVoteThreshold = 6` and `MinimalApprovalThreshold = 4`
- A proposal receives 4 approvals from members (meeting approval threshold)
- 2 additional members vote (approval/rejection/abstention - type irrelevant)
- Through governance action, the organization removes those 2 members
- When `Release()` is called, the threshold check passes:
  - Current member approvals: 4 ≥ 4 ✓
  - Total votes (including removed members): 6 ≥ 6 ✓
- **Without the vulnerability**: Total votes from current members would be 4 < 6, failing the check

**Who is affected**: All organizations using the Association contract for governance, particularly those with strict participation requirements. The `MinimalVoteThreshold` is intended to ensure adequate participation but can be circumvented.

**Severity**: High - this directly undermines a core governance security control defined in the critical invariants for authorization and governance thresholds.

### Likelihood Explanation

**Feasible Preconditions**:
- A proposal must be created and receive votes
- Members must then be removed from the organization

**Attacker Capabilities**:
- An individual attacker **cannot** unilaterally exploit this - `RemoveMember()` requires `Context.Sender` to be the organization address (governance action). [6](#0-5) 
- However, this can occur through:
  1. **Collusion**: Multiple organization members coordinate to vote then remove themselves via governance
  2. **Normal Operations**: Legitimate member removal (inactive members, reorganization) after votes are cast unintentionally triggers the vulnerability

**Execution Practicality**: 
- The vulnerability is triggered through standard contract operations
- No special privileges beyond normal organizational governance required
- Can occur unintentionally during routine member management

**Detection Constraints**: The inconsistency is subtle and would not be obvious during normal operations. Organizations would not realize proposals are passing with insufficient current member participation.

**Probability**: Medium-High - while requiring governance action for member removal, this can happen both through malicious coordination and normal operational changes, making it a realistic threat.

### Recommendation

**Code-level Mitigation**: Modify `CheckEnoughVoteAndApprovals()` to consistently filter all vote counts by current membership:

```csharp
private bool CheckEnoughVoteAndApprovals(ProposalInfo proposal, Organization organization)
{
    var approvedMemberCount = proposal.Approvals.Count(organization.OrganizationMemberList.Contains);
    var isApprovalEnough =
        approvedMemberCount >= organization.ProposalReleaseThreshold.MinimalApprovalThreshold;
    if (!isApprovalEnough)
        return false;

    // FIX: Filter total votes by current membership
    var currentMemberVotes = proposal.Abstentions.Concat(proposal.Approvals).Concat(proposal.Rejections)
        .Count(organization.OrganizationMemberList.Contains);
    var isVoteThresholdReached =
        currentMemberVotes >= organization.ProposalReleaseThreshold.MinimalVoteThreshold;
    return isVoteThresholdReached;
}
```

**Invariant to Enforce**: All threshold calculations must use only votes from current organization members to ensure governance requirements reflect current membership state.

**Test Cases**:
1. Member votes, then is removed - verify their vote does NOT count toward any threshold
2. Multiple members vote, some removed - verify only current member votes count toward MinimalVoteThreshold
3. Proposal with enough votes becomes invalid after member removal - verify it cannot be released

### Proof of Concept

**Initial State**:
- Organization with members [A, B, C, D, E, F, G, H, I, J] (10 members)
- Thresholds: `MinimalVoteThreshold = 6`, `MinimalApprovalThreshold = 4`, `MaximalRejectionThreshold = 10`, `MaximalAbstentionThreshold = 10`
- Proposal P created

**Attack Steps**:
1. Members A, B, C, D call `Approve(P)` - 4 approvals recorded
2. Members E, F call `Approve(P)` - now 6 approvals total  
3. Organization calls `RemoveMember(E)` and `RemoveMember(F)` through governance
4. Organization state: 8 current members [A, B, C, D, G, H, I, J]
5. Proposer calls `Release(P)`

**Expected Result (Secure Behavior)**:
- Current member approvals: 4 ≥ 4 ✓
- Current member total votes: 4 < 6 ✗
- `Release()` should fail with "Not approved"

**Actual Result (Vulnerable Behavior)**:
- Current member approvals: 4 ≥ 4 ✓ (line 49-51 filters correctly)
- Total votes: 6 ≥ 6 ✓ (line 56-57 includes E and F despite removal)
- `Release()` succeeds and executes the proposal

**Success Condition**: Proposal executes despite only 4 of 8 current members voting, when threshold requires 6 votes, demonstrating the MinimalVoteThreshold bypass.

### Citations

**File:** contract/AElf.Contracts.Association/Association.cs (L130-130)
```csharp
        proposal.Approvals.Add(Context.Sender);
```

**File:** contract/AElf.Contracts.Association/Association.cs (L266-273)
```csharp
    public override Empty RemoveMember(Address input)
    {
        var organization = State.Organizations[Context.Sender];
        Assert(organization != null, "Organization not found.");
        var removeResult = organization.OrganizationMemberList.OrganizationMembers.Remove(input);
        Assert(removeResult, "Remove member failed.");
        Assert(Validate(organization), "Invalid organization.");
        State.Organizations[Context.Sender] = organization;
```

**File:** contract/AElf.Contracts.Association/Association_Helper.cs (L36-44)
```csharp
        var rejectionMemberCount =
            proposal.Rejections.Count(organization.OrganizationMemberList.Contains);
        return rejectionMemberCount > organization.ProposalReleaseThreshold.MaximalRejectionThreshold;
    }

    private bool IsProposalAbstained(ProposalInfo proposal, Organization organization)
    {
        var abstentionMemberCount = proposal.Abstentions.Count(organization.OrganizationMemberList.Contains);
        return abstentionMemberCount > organization.ProposalReleaseThreshold.MaximalAbstentionThreshold;
```

**File:** contract/AElf.Contracts.Association/Association_Helper.cs (L49-51)
```csharp
        var approvedMemberCount = proposal.Approvals.Count(organization.OrganizationMemberList.Contains);
        var isApprovalEnough =
            approvedMemberCount >= organization.ProposalReleaseThreshold.MinimalApprovalThreshold;
```

**File:** contract/AElf.Contracts.Association/Association_Helper.cs (L55-58)
```csharp
        var isVoteThresholdReached =
            proposal.Abstentions.Concat(proposal.Approvals).Concat(proposal.Rejections).Count() >=
            organization.ProposalReleaseThreshold.MinimalVoteThreshold;
        return isVoteThresholdReached;
```
