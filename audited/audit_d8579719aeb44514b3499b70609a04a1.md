### Title
Inconsistent Vote Counting Allows Governance Manipulation Through Strategic Member Removal

### Summary
The `CheckEnoughVoteAndApprovals` function contains an inconsistency where `MinimalApprovalThreshold` is checked against current members only, but `MinimalVoteThreshold` is checked against all historical votes including removed members. This allows organizations to manipulate proposal outcomes by strategically removing members after they vote, causing proposals to pass with insufficient current member participation. [1](#0-0) 

### Finding Description

The vulnerability exists in the vote counting logic across multiple threshold check functions in `Association_Helper.cs`:

1. **Approval Threshold Check** (line 49): Filters votes to count only current members using `.Count(organization.OrganizationMemberList.Contains)` [2](#0-1) 

2. **Vote Threshold Check** (lines 56-57): Counts ALL votes without filtering for current membership using `.Count()` on the concatenated lists [3](#0-2) 

3. **Rejection/Abstention Checks** (lines 37, 43): Also filter for current members only [4](#0-3) 

The root cause is that when members vote and are subsequently removed via `RemoveMember`, their votes remain in the proposal's vote lists but are only counted selectively:
- Ex-member votes ARE counted toward `MinimalVoteThreshold` (no filter)
- Ex-member votes are NOT counted toward `MinimalApprovalThreshold`, `MaximalRejectionThreshold`, or `MaximalAbstentionThreshold` (filtered out) [5](#0-4) 

This violates the intended semantics confirmed by the validation logic that bounds `MinimalVoteThreshold` by organization member count: [6](#0-5) 

### Impact Explanation

**Governance Manipulation**: Organizations can game their own threshold checks to pass proposals that should be blocked. For example:
- Organization has: MinimalApprovalThreshold=3, MinimalVoteThreshold=8, MaximalAbstentionThreshold=2
- 3 members approve, 2 reject, 3 abstain (8 total votes)
- Proposal fails due to abstentionMemberCount (3) > MaximalAbstentionThreshold (2)
- Organization removes the 3 abstaining members
- Re-evaluation: abstentionMemberCount=0 (only current members), totalVotes=8 (includes ex-members)
- Proposal now PASSES despite insufficient current member participation

**Violation of Governance Invariants**: The threshold system is designed to ensure adequate participation from current members. The inconsistency allows proposals to pass with as few as `MinimalApprovalThreshold` current member approvals while appearing to meet the `MinimalVoteThreshold` participation requirement through ex-member votes.

**Affected Parties**: All organizations using the Association contract where proposals can remain active during membership changes, particularly those with multi-threshold governance requirements.

### Likelihood Explanation

**Attacker Capabilities**: Requires organization-level authority to call `RemoveMember`, achievable through legitimate governance (passing a removal proposal) or by the organization's authorized controllers. [7](#0-6) 

**Attack Complexity**: Low - straightforward sequence of normal operations:
1. Members vote on a proposal
2. Organization removes specific members (those who abstained or rejected)
3. Proposal is released with manipulated threshold calculations

**Feasibility Conditions**: 
- Proposals with sufficient lifetime for membership changes to occur
- Organizations with dynamic membership
- No code prevents counting ex-member votes in `MinimalVoteThreshold`

**Detection**: Difficult to detect as both member removal and proposal release are legitimate operations. The manipulation occurs in the implicit vote counting logic rather than explicit transaction parameters.

### Recommendation

**Code-Level Mitigation**: Add consistent member filtering to the `MinimalVoteThreshold` check in `CheckEnoughVoteAndApprovals`:

```csharp
private bool CheckEnoughVoteAndApprovals(ProposalInfo proposal, Organization organization)
{
    var approvedMemberCount = proposal.Approvals.Count(organization.OrganizationMemberList.Contains);
    var isApprovalEnough =
        approvedMemberCount >= organization.ProposalReleaseThreshold.MinimalApprovalThreshold;
    if (!isApprovalEnough)
        return false;

    // FIX: Filter for current members only
    var currentMemberVoteCount = 
        proposal.Abstentions.Count(organization.OrganizationMemberList.Contains) +
        proposal.Approvals.Count(organization.OrganizationMemberList.Contains) +
        proposal.Rejections.Count(organization.OrganizationMemberList.Contains);
    
    var isVoteThresholdReached =
        currentMemberVoteCount >= organization.ProposalReleaseThreshold.MinimalVoteThreshold;
    return isVoteThresholdReached;
}
```

**Invariant Checks**: Ensure all threshold calculations filter for current membership to maintain semantic consistency.

**Test Cases**: Add regression tests for scenarios where members vote and are subsequently removed before proposal release, verifying their votes don't artificially satisfy `MinimalVoteThreshold`.

### Proof of Concept

**Initial State**:
- Organization with 10 members: M1-M10
- Thresholds: MinimalApprovalThreshold=3, MinimalVoteThreshold=8, MaximalAbstentionThreshold=2

**Step 1**: Create proposal P1

**Step 2**: Members vote on P1:
- M1, M2, M3 approve (3 approvals)
- M4, M5 reject (2 rejections)
- M6, M7, M8 abstain (3 abstentions)
- Total: 8 votes

**Step 3**: Check threshold (should FAIL):
- approvedMemberCount = 3 >= 3 ✓
- rejectionMemberCount = 2 <= default ✓
- abstentionMemberCount = 3 > 2 ✗ (BLOCKS proposal)
- Proposal CANNOT be released

**Step 4**: Organization passes proposal P2 to remove M6, M7, M8 (the abstainers)

**Step 5**: Check threshold on P1 again (now PASSES):
- approvedMemberCount = 3 (current members only) >= 3 ✓
- rejectionMemberCount = 2 (current members only) <= default ✓
- abstentionMemberCount = 0 (M6-M8 removed, filter excludes them) <= 2 ✓
- totalVotes = 8 (NO FILTER, still counts M6-M8) >= 8 ✓
- Proposal CAN NOW be released ✓

**Expected vs Actual**: 
- Expected: Proposal P1 should remain blocked due to insufficient current member participation (only 5 current members voted)
- Actual: Proposal P1 passes because ex-member votes count toward `MinimalVoteThreshold`

**Success Condition**: Proposal P1 is releasable after member removal despite having only 5 votes from current members against a `MinimalVoteThreshold` of 8.

### Citations

**File:** contract/AElf.Contracts.Association/Association_Helper.cs (L34-45)
```csharp
    private bool IsProposalRejected(ProposalInfo proposal, Organization organization)
    {
        var rejectionMemberCount =
            proposal.Rejections.Count(organization.OrganizationMemberList.Contains);
        return rejectionMemberCount > organization.ProposalReleaseThreshold.MaximalRejectionThreshold;
    }

    private bool IsProposalAbstained(ProposalInfo proposal, Organization organization)
    {
        var abstentionMemberCount = proposal.Abstentions.Count(organization.OrganizationMemberList.Contains);
        return abstentionMemberCount > organization.ProposalReleaseThreshold.MaximalAbstentionThreshold;
    }
```

**File:** contract/AElf.Contracts.Association/Association_Helper.cs (L47-59)
```csharp
    private bool CheckEnoughVoteAndApprovals(ProposalInfo proposal, Organization organization)
    {
        var approvedMemberCount = proposal.Approvals.Count(organization.OrganizationMemberList.Contains);
        var isApprovalEnough =
            approvedMemberCount >= organization.ProposalReleaseThreshold.MinimalApprovalThreshold;
        if (!isApprovalEnough)
            return false;

        var isVoteThresholdReached =
            proposal.Abstentions.Concat(proposal.Approvals).Concat(proposal.Rejections).Count() >=
            organization.ProposalReleaseThreshold.MinimalVoteThreshold;
        return isVoteThresholdReached;
    }
```

**File:** contract/AElf.Contracts.Association/Association_Helper.cs (L72-73)
```csharp
        return proposalReleaseThreshold.MinimalVoteThreshold <= organizationMemberCount &&
               proposalReleaseThreshold.MinimalApprovalThreshold <= proposalReleaseThreshold.MinimalVoteThreshold &&
```

**File:** contract/AElf.Contracts.Association/Association.cs (L266-279)
```csharp
    public override Empty RemoveMember(Address input)
    {
        var organization = State.Organizations[Context.Sender];
        Assert(organization != null, "Organization not found.");
        var removeResult = organization.OrganizationMemberList.OrganizationMembers.Remove(input);
        Assert(removeResult, "Remove member failed.");
        Assert(Validate(organization), "Invalid organization.");
        State.Organizations[Context.Sender] = organization;
        Context.Fire(new MemberRemoved
        {
            OrganizationAddress = Context.Sender,
            Member = input
        });
        return new Empty();
```
