### Title
Inconsistent Vote Counting Allows Non-Member Votes to Inflate Participation Threshold

### Summary
The Association contract's release threshold calculation contains an inconsistency where votes from removed members are excluded from approval/rejection/abstention counts but included in the total vote participation count. This allows proposals to be released with fewer actual member votes than required by the MinimalVoteThreshold governance parameter, enabling governance bypass through member manipulation.

### Finding Description

The vulnerability exists in the threshold calculation logic within `IsReleaseThresholdReached` and its helper functions. When a member votes on a proposal and is subsequently removed from the organization, their vote remains permanently stored in the proposal's vote lists. [1](#0-0) 

During the voting process, the `Approve` function (and similarly `Reject`/`Abstain`) validates that the sender is a current member before adding their vote to the proposal. [2](#0-1) 

However, when members are removed via `RemoveMember`, only the organization's member list is updated - the proposal's vote lists remain unchanged. [3](#0-2) 

The critical flaw occurs in the release threshold calculation. The `CheckEnoughVoteAndApprovals` function counts approvals only from current members using a filter: [4](#0-3) 

Similarly, rejection and abstention counts also filter by current membership: [5](#0-4) [6](#0-5) 

But the MinimalVoteThreshold check counts ALL votes without any membership filter: [7](#0-6) 

This inconsistency means votes from removed members contribute to meeting the MinimalVoteThreshold requirement while not affecting approval/rejection/abstention thresholds.

### Impact Explanation

This vulnerability allows governance bypass through vote count inflation:

**Concrete Harm:**
- Proposals can be released with fewer actual member votes than intended by the MinimalVoteThreshold parameter
- Organizations can manipulate membership to artificially inflate participation counts
- The fundamental governance invariant that "MinimalVoteThreshold represents required participation from actual members" is violated

**Quantified Impact:**
Consider an organization with:
- 10 permanent members
- MinimalVoteThreshold = 7
- MinimalApprovalThreshold = 5

Attack scenario:
1. 5 permanent members approve a proposal (meets MinimalApprovalThreshold)
2. Organization adds 3 temporary members
3. Temporary members vote (approval/rejection/abstention doesn't matter)
4. Organization removes the 3 temporary members
5. Proposal now has 8 total votes (meets MinimalVoteThreshold ≥ 7) but only 5 from actual members
6. Proposal can be released despite only 50% actual member participation instead of the required 70%

**Affected Parties:**
- All Association organizations relying on MinimalVoteThreshold for participation requirements
- Minority stakeholders who depend on participation thresholds to prevent low-turnout proposals

**Severity Justification:**
HIGH - This directly violates governance security by allowing proposals to pass with insufficient actual member participation, potentially enabling unauthorized contract calls through the organization's authority.

### Likelihood Explanation

**Attacker Capabilities:**
The organization itself can execute this attack through its own proposal mechanism, or it can occur naturally through legitimate member management operations.

**Attack Complexity:**
LOW - Requires only standard organization operations:
1. Create proposals to add/remove members (standard governance)
2. Have temporary members vote during their membership period
3. Remove those members through another proposal

**Feasibility Conditions:**
- Organizations naturally add and remove members for legitimate reasons
- No special privileges required beyond normal organization governance
- Attack can be executed intentionally or occur accidentally

**Detection Constraints:**
- Vote histories are visible on-chain, but the inconsistent counting logic is not obvious
- Organizations may not realize their participation thresholds are being bypassed
- No events or warnings indicate when non-member votes inflate thresholds

**Probability:**
HIGH - This can occur in two scenarios:
1. Intentional: Malicious organization operators can deliberately manipulate membership
2. Accidental: Natural member turnover causes historical votes to inflate participation counts

### Recommendation

**Code-Level Mitigation:**
Modify the MinimalVoteThreshold check in `CheckEnoughVoteAndApprovals` to filter votes by current membership, maintaining consistency with approval/rejection/abstention counting:

```csharp
// In Association_Helper.cs, replace lines 55-57 with:
var currentMemberVotes = proposal.Abstentions
    .Concat(proposal.Approvals)
    .Concat(proposal.Rejections)
    .Count(organization.OrganizationMemberList.Contains);
var isVoteThresholdReached = currentMemberVotes >= 
    organization.ProposalReleaseThreshold.MinimalVoteThreshold;
```

**Alternative Approach:**
Implement vote removal when members are removed from the organization:

```csharp
// In Association.cs RemoveMember function, after line 270:
// Remove member's votes from all active proposals
foreach (var proposalId in GetActiveProposalIds(Context.Sender))
{
    var proposal = State.Proposals[proposalId];
    if (proposal != null)
    {
        proposal.Approvals.Remove(input);
        proposal.Rejections.Remove(input);
        proposal.Abstentions.Remove(input);
        State.Proposals[proposalId] = proposal;
    }
}
```

**Invariant Checks:**
Add assertion in `IsReleaseThresholdReached` to ensure all voters are current members before release.

**Test Cases:**
1. Member votes, gets removed, verify vote doesn't count toward any threshold
2. Temporary member voting scenario with threshold validation
3. Concurrent membership changes during active proposals

### Proof of Concept

**Initial State:**
- Organization created with 10 members: M1-M10
- Thresholds: MinimalVoteThreshold=7, MinimalApprovalThreshold=5, MaximalRejectionThreshold=3, MaximalAbstentionThreshold=3

**Transaction Sequence:**

1. **Create Proposal P1** (proposer: M1)
   - Target: Execute privileged contract method
   - ExpiredTime: +30 days

2. **5 members approve** (M1, M2, M3, M4, M5)
   - Each calls `Approve(P1)`
   - Current state: 5 approvals from members, total 5 votes

3. **Add 3 temporary members** (T1, T2, T3)
   - Create proposal P2: `AddMember(T1)`, release when approved
   - Create proposal P3: `AddMember(T2)`, release when approved
   - Create proposal P4: `AddMember(T3)`, release when approved
   - Organization now has 13 members

4. **Temporary members vote on P1**
   - T1 calls `Approve(P1)` - succeeds (is member)
   - T2 calls `Reject(P1)` - succeeds (is member)
   - T3 calls `Abstain(P1)` - succeeds (is member)
   - Current state: 6 approvals, 1 rejection, 1 abstention, total 8 votes

5. **Remove temporary members**
   - Create proposal P5: `RemoveMember(T1)`, release when approved
   - Create proposal P6: `RemoveMember(T2)`, release when approved
   - Create proposal P7: `RemoveMember(T3)`, release when approved
   - Organization back to 10 members

6. **Attempt to Release P1** (M1 calls `Release(P1)`)

**Expected Result:**
Proposal P1 should NOT be releasable because only 5 of 10 actual members voted (50%), which is less than MinimalVoteThreshold of 7 (70%).

**Actual Result:**
Proposal P1 IS releasable because:
- `approvedMemberCount = 5` (T1's approval filtered out, only M1-M5 counted) ≥ MinimalApprovalThreshold (5) ✓
- `rejectionMemberCount = 0` (T2's rejection filtered out) ≤ MaximalRejectionThreshold (3) ✓
- `abstentionMemberCount = 0` (T3's abstention filtered out) ≤ MaximalAbstentionThreshold (3) ✓
- `totalVotes = 8` (T1, T2, T3 still counted) ≥ MinimalVoteThreshold (7) ✓

All thresholds pass, P1 executes successfully with only 50% actual member participation.

**Success Condition:**
The vulnerability is confirmed if Release succeeds despite insufficient actual member participation.

### Citations

**File:** contract/AElf.Contracts.Association/Association.cs (L123-141)
```csharp
    public override Empty Approve(Hash input)
    {
        var proposal = GetValidProposal(input);
        AssertProposalNotYetVotedBySender(proposal, Context.Sender);
        var organization = GetOrganization(proposal.OrganizationAddress);
        AssertIsAuthorizedOrganizationMember(organization, Context.Sender);

        proposal.Approvals.Add(Context.Sender);
        State.Proposals[input] = proposal;
        Context.Fire(new ReceiptCreated
        {
            Address = Context.Sender,
            ProposalId = input,
            Time = Context.CurrentBlockTime,
            ReceiptType = nameof(Approve),
            OrganizationAddress = proposal.OrganizationAddress
        });
        return new Empty();
    }
```

**File:** contract/AElf.Contracts.Association/Association.cs (L266-280)
```csharp
    public override Empty RemoveMember(Address input)
    {
        var organization = State.Organizations[Context.Sender];
        Assert(organization != null, "Organization not found.");
        var removeResult = organization.OrganizationMemberList.OrganizationMembers.Remove(input);
        Assert(removeResult, "Remove member failed.");
        Assert(Validate(organization), "Invalid organization.");
        State.Organizations[Context.Sender] = organization;
        Context.Fire(new MemberRemoved
        {
            OrganizationAddress = Context.Sender,
            Member = input
        });
        return new Empty();
    }
```

**File:** contract/AElf.Contracts.Association/Association_Helper.cs (L18-22)
```csharp
    private void AssertIsAuthorizedOrganizationMember(Organization organization, Address member)
    {
        Assert(organization.OrganizationMemberList.Contains(member),
            "Unauthorized member.");
    }
```

**File:** contract/AElf.Contracts.Association/Association_Helper.cs (L36-38)
```csharp
        var rejectionMemberCount =
            proposal.Rejections.Count(organization.OrganizationMemberList.Contains);
        return rejectionMemberCount > organization.ProposalReleaseThreshold.MaximalRejectionThreshold;
```

**File:** contract/AElf.Contracts.Association/Association_Helper.cs (L43-44)
```csharp
        var abstentionMemberCount = proposal.Abstentions.Count(organization.OrganizationMemberList.Contains);
        return abstentionMemberCount > organization.ProposalReleaseThreshold.MaximalAbstentionThreshold;
```

**File:** contract/AElf.Contracts.Association/Association_Helper.cs (L49-51)
```csharp
        var approvedMemberCount = proposal.Approvals.Count(organization.OrganizationMemberList.Contains);
        var isApprovalEnough =
            approvedMemberCount >= organization.ProposalReleaseThreshold.MinimalApprovalThreshold;
```

**File:** contract/AElf.Contracts.Association/Association_Helper.cs (L55-57)
```csharp
        var isVoteThresholdReached =
            proposal.Abstentions.Concat(proposal.Approvals).Concat(proposal.Rejections).Count() >=
            organization.ProposalReleaseThreshold.MinimalVoteThreshold;
```
