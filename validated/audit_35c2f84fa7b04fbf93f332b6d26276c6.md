# Audit Report

## Title
Sponsor Can Extend Voting Period Indefinitely Beyond Declared EndTimestamp

## Summary
The Vote contract fails to enforce the declared `EndTimestamp` when accepting votes or taking snapshots, allowing sponsors to manipulate governance outcomes by extending voting periods arbitrarily past the publicly declared deadline.

## Finding Description

The Vote contract implements a snapshot-based voting system where `EndTimestamp` is explicitly defined as "The end time of the voting" [1](#0-0) , but this timestamp is never enforced during voting operations.

During registration, the contract validates that `EndTimestamp > StartTimestamp` [2](#0-1)  and stores both timestamps in the voting item [3](#0-2) . However, the `AssertValidVoteInput()` function only validates snapshot numbers without any timestamp comparison [4](#0-3) .

Similarly, when the sponsor calls `TakeSnapshot()`, the function only verifies sponsor authorization and snapshot number bounds [5](#0-4) , then sets the snapshot end timestamp to the current block time without validation against the declared `EndTimestamp` [6](#0-5) .

**Exploitation Scenario:**
1. Sponsor registers a voting item declaring it ends at time T (e.g., 7 days from now)
2. Users cast votes based on the declared 7-day deadline
3. Time T passes, but sponsor does not call `TakeSnapshot()`
4. Users can continue voting indefinitely since only `CurrentSnapshotNumber <= TotalSnapshotNumber` is checked
5. Sponsor observes voting trends and strategically delays the snapshot until outcomes are favorable
6. Sponsor finally calls `TakeSnapshot()` at time T+N (where N can be arbitrarily large)

## Impact Explanation

**Governance Manipulation:** The sponsor gains the ability to manipulate voting outcomes through strategic timing. By observing voting patterns after the declared deadline, the sponsor can coordinate with aligned voters to cast additional votes when opposition has stopped participating, or wait until natural vote distribution favors their desired outcome.

**Trust and Protocol Integrity Violation:** The `EndTimestamp` field is prominently stored in the voting item structure [7](#0-6)  and emitted in registration events [8](#0-7) , creating a clear expectation that voting ends at this timestamp. Breaking this guarantee undermines user trust in the voting system's fairness and predictability.

This issue has **Medium severity** because:
- It enables systematic manipulation of governance decisions across all voting activities
- While no direct fund theft occurs, it compromises the integrity of governance mechanisms that control protocol parameters, upgrades, and resource allocation
- The impact extends beyond individual votes to affect overall protocol governance credibility

## Likelihood Explanation

**High Likelihood:** The attack requires only sponsor authority (which is legitimate) and simple inactionâ€”the sponsor merely delays calling `TakeSnapshot()`. No sophisticated techniques, external resources, or special blockchain conditions are needed.

**Realistic Threat Model:** While sponsors are expected to act honestly, this assumption is unsafe because:
- Sponsors may have direct financial interests in voting outcomes
- Sponsor accounts can be compromised
- Competing governance proposals often involve sponsors with conflicting interests
- Economic incentives may outweigh reputational concerns, especially for anonymous or pseudonymous sponsors

**Low Detection Difficulty:** The manipulation is nearly undetectable since the contract provides no mechanism to query whether a vote has exceeded its declared `EndTimestamp`, and sponsor delays appear as normal operational timing variations.

## Recommendation

Add timestamp validation in both the `Vote()` and `TakeSnapshot()` functions:

**In AssertValidVoteInput():**
```csharp
Assert(Context.CurrentBlockTime <= votingItem.EndTimestamp, 
    "Voting period has ended.");
```

**In TakeSnapshot():**
```csharp
Assert(Context.CurrentBlockTime <= votingItem.EndTimestamp.AddDays(GRACE_PERIOD),
    "Cannot take snapshot: too far past declared end time.");
```

Consider adding a grace period constant to allow reasonable operational delays while preventing indefinite extensions.

## Proof of Concept

```csharp
[Fact]
public async Task Sponsor_Can_Extend_Voting_Past_EndTimestamp()
{
    // Register voting item with 1 day duration, 2 snapshots
    var votingItem = await RegisterVotingItemAsync(1, 3, true, DefaultSender, 2);
    var user1 = Accounts[1];
    
    // User votes before declared EndTimestamp
    await Vote(user1.KeyPair, votingItem.VotingItemId, votingItem.Options[0], 100);
    
    // Advance time past declared EndTimestamp by 10 days
    BlockTimeProvider.SetBlockTime(votingItem.EndTimestamp.AddDays(10));
    
    // Voting should fail but doesn't - sponsor can still accept votes
    var lateVote = await Vote(user1.KeyPair, votingItem.VotingItemId, votingItem.Options[1], 200);
    lateVote.Status.ShouldBe(TransactionResultStatus.Mined); // Should fail but succeeds!
    
    // Sponsor can still take snapshot arbitrarily late
    var snapshotResult = await TakeSnapshot(votingItem.VotingItemId, 1);
    snapshotResult.Status.ShouldBe(TransactionResultStatus.Mined);
    
    // Verify vote 10 days past deadline was recorded
    var result = await GetVotingResult(votingItem.VotingItemId, 1);
    result.Results[votingItem.Options[1]].ShouldBe(200); // Late vote counted!
}
```

### Citations

**File:** protobuf/vote_contract.proto (L90-91)
```text
    // The end time of the voting.
    google.protobuf.Timestamp end_timestamp = 2;
```

**File:** protobuf/vote_contract.proto (L123-124)
```text
    // The end time of the voting.
    google.protobuf.Timestamp end_timestamp = 9;
```

**File:** contract/AElf.Contracts.Vote/VoteContract.cs (L46-47)
```csharp
            StartTimestamp = input.StartTimestamp,
            EndTimestamp = input.EndTimestamp,
```

**File:** contract/AElf.Contracts.Vote/VoteContract.cs (L75-75)
```csharp
            EndTimestamp = votingItem.EndTimestamp,
```

**File:** contract/AElf.Contracts.Vote/VoteContract.cs (L245-248)
```csharp
        Assert(votingItem.Sponsor == Context.Sender, "Only sponsor can take snapshot.");

        Assert(votingItem.CurrentSnapshotNumber - 1 < votingItem.TotalSnapshotNumber,
            "Current voting item already ended.");
```

**File:** contract/AElf.Contracts.Vote/VoteContract.cs (L253-253)
```csharp
        previousVotingResult.SnapshotEndTimestamp = Context.CurrentBlockTime;
```

**File:** contract/AElf.Contracts.Vote/VoteContract.cs (L361-361)
```csharp
        Assert(input.EndTimestamp > input.StartTimestamp, "Invalid active time.");
```

**File:** contract/AElf.Contracts.Vote/VoteContract.cs (L382-383)
```csharp
        Assert(votingItem.CurrentSnapshotNumber <= votingItem.TotalSnapshotNumber,
            "Current voting item already ended.");
```
