# Audit Report

## Title
Incomplete Threshold Validation Allows Creation of Deadlocked Organizations

## Summary
The `Validate(Organization)` function in the Association contract fails to verify that threshold parameters allow for any valid vote distribution. This enables creation of organizations where no proposal can mathematically pass, resulting in permanent governance deadlock that cannot be remedied.

## Finding Description

The validation logic in `Validate(Organization)` [1](#0-0)  performs independent pairwise checks on threshold combinations but fails to validate the combined constraint required for proposal passage.

**Current Validation Checks:**
1. `MaximalAbstentionThreshold + MinimalApprovalThreshold <= organizationMemberCount`
2. `MaximalRejectionThreshold + MinimalApprovalThreshold <= organizationMemberCount`

**Missing Validation:**
The code does not verify: `MaximalAbstentionThreshold + MaximalRejectionThreshold + MinimalApprovalThreshold >= MinimalVoteThreshold`

**Proposal Release Logic:**
The release mechanism [2](#0-1)  requires:
- Rejections must not exceed `MaximalRejectionThreshold` (else rejected)
- Abstentions must not exceed `MaximalAbstentionThreshold` (else abstained)  
- Approvals must meet `MinimalApprovalThreshold`
- Total votes must reach `MinimalVoteThreshold`

**Mathematical Deadlock:**
When `MinimalVoteThreshold` requires all or most members to vote, and `MaximalAbstentionThreshold + MaximalRejectionThreshold < (MinimalVoteThreshold - MinimalApprovalThreshold)`, it becomes impossible to distribute the non-approval votes without exceeding at least one threshold.

**Example Configuration (passes current validation):**
- organizationMemberCount = 10
- MinimalApprovalThreshold = 5
- MinimalVoteThreshold = 10  
- MaximalAbstentionThreshold = 2
- MaximalRejectionThreshold = 2

With 5 approvals, 5 votes remain. Maximum allowed non-approval votes = 2 + 2 = 4, but 5 must be distributed. Any vote distribution violates a threshold, making approval impossible.

**Entry Point:**
Anyone can create such organizations via the public `CreateOrganization` method [3](#0-2)  with no authorization requirements.

**Permanence:**
The `ChangeOrganizationThreshold` method [4](#0-3)  can only be invoked by the organization itself through a proposal. Since no proposals can pass in a deadlocked organization, thresholds can never be corrected, making the deadlock permanent.

## Impact Explanation

**Severity: High Impact**

This vulnerability breaks the fundamental governance guarantee that properly configured organizations can pass proposals. Affected organizations experience:

1. **Complete Governance Failure**: All proposals fail regardless of member voting behavior
2. **Permanent Irreversibility**: No recovery mechanism exists since threshold changes require proposals
3. **Operational DoS**: Organizations become permanently non-functional for their intended governance purpose
4. **Honeypot Risk**: Malicious actors could create organizations appearing legitimate but designed to trap member participation

While no funds are directly stolen, this represents a critical failure of the governance system's core functionality with permanent consequences.

## Likelihood Explanation

**Likelihood: Medium-High**

**Reachability:** Direct - `CreateOrganization` is a public, permissionless method requiring only transaction fees.

**Preconditions:** None required beyond crafting threshold parameters that pass individual checks but fail the combined constraint.

**Occurrence Scenarios:**
1. **Accidental Misconfiguration**: Legitimate users unfamiliar with the complex threshold interactions could create deadlocked organizations unintentionally
2. **Malicious Creation**: Attackers could deliberately create honeypot organizations to waste member resources or damage governance reputation
3. **Threshold Updates**: Existing organizations using `ChangeOrganizationThreshold` could accidentally deadlock themselves

**Detection Gap:** The test suite [5](#0-4)  validates individual threshold constraints but lacks coverage for combined constraint deadlock scenarios.

## Recommendation

Add an additional validation check in the `Validate(Organization)` method to ensure vote distribution feasibility:

```csharp
private bool Validate(Organization organization)
{
    // ... existing checks ...
    
    var proposalReleaseThreshold = organization.ProposalReleaseThreshold;
    var organizationMemberCount = organization.OrganizationMemberList.Count();
    
    return proposalReleaseThreshold.MinimalVoteThreshold <= organizationMemberCount &&
           proposalReleaseThreshold.MinimalApprovalThreshold <= proposalReleaseThreshold.MinimalVoteThreshold &&
           proposalReleaseThreshold.MinimalApprovalThreshold > 0 &&
           proposalReleaseThreshold.MaximalAbstentionThreshold >= 0 &&
           proposalReleaseThreshold.MaximalRejectionThreshold >= 0 &&
           proposalReleaseThreshold.MaximalAbstentionThreshold +
           proposalReleaseThreshold.MinimalApprovalThreshold <= organizationMemberCount &&
           proposalReleaseThreshold.MaximalRejectionThreshold +
           proposalReleaseThreshold.MinimalApprovalThreshold <= organizationMemberCount &&
           // NEW CHECK: Ensure vote distribution is mathematically possible
           proposalReleaseThreshold.MaximalAbstentionThreshold +
           proposalReleaseThreshold.MaximalRejectionThreshold +
           proposalReleaseThreshold.MinimalApprovalThreshold >= proposalReleaseThreshold.MinimalVoteThreshold;
}
```

**Note:** The same issue exists in Parliament [6](#0-5)  and Referendum [7](#0-6)  contracts and should be fixed there as well.

## Proof of Concept

```csharp
[Fact]
public async Task CreateOrganization_WithDeadlockedThresholds_ShouldFail()
{
    // Create organization with mathematically impossible thresholds
    var createOrganizationInput = new CreateOrganizationInput
    {
        OrganizationMemberList = new OrganizationMemberList
        {
            // 10 members
            OrganizationMembers = { 
                Reviewer1, Reviewer2, Reviewer3, Reviewer4, Reviewer5,
                Reviewer6, Reviewer7, Reviewer8, Reviewer9, Reviewer10 
            }
        },
        ProposalReleaseThreshold = new ProposalReleaseThreshold
        {
            MinimalApprovalThreshold = 5,      // Need 5 approvals
            MinimalVoteThreshold = 10,          // All 10 must vote
            MaximalAbstentionThreshold = 2,     // Max 2 abstentions
            MaximalRejectionThreshold = 2       // Max 2 rejections
            // Problem: 2 + 2 + 5 = 9 < 10, making approval impossible
        },
        ProposerWhiteList = new ProposerWhiteList { Proposers = { Reviewer1 } }
    };
    
    // Current behavior: Organization is created (VULNERABLE)
    var result = await AssociationContractStub.CreateOrganization.SendAsync(createOrganizationInput);
    result.TransactionResult.Status.ShouldBe(TransactionResultStatus.Mined);
    
    var organizationAddress = result.Output;
    
    // Create a proposal
    var proposalId = await CreateProposalAsync(Reviewer1KeyPair, organizationAddress);
    
    // Scenario: Exactly 5 members approve
    await ApproveAsync(Reviewer1KeyPair, proposalId);
    await ApproveAsync(Reviewer2KeyPair, proposalId);
    await ApproveAsync(Reviewer3KeyPair, proposalId);
    await ApproveAsync(Reviewer4KeyPair, proposalId);
    await ApproveAsync(Reviewer5KeyPair, proposalId);
    
    // Remaining 5 members must vote (MinimalVoteThreshold=10)
    // Try distributing: 2 abstain, 3 reject
    await AbstainAsync(Reviewer6KeyPair, proposalId);
    await AbstainAsync(Reviewer7KeyPair, proposalId);
    await RejectAsync(Reviewer8KeyPair, proposalId);
    await RejectAsync(Reviewer9KeyPair, proposalId);
    await RejectAsync(Reviewer10KeyPair, proposalId);
    
    // Check proposal status: Should NOT be releasable (rejected due to 3 > 2 rejections)
    var proposal = await AssociationContractStub.GetProposal.CallAsync(proposalId);
    proposal.ToBeReleased.ShouldBeFalse();
    
    // Try any other distribution - will always fail due to mathematical impossibility
    // This proves the organization is permanently deadlocked
}
```

### Citations

**File:** contract/AElf.Contracts.Association/Association_Helper.cs (L24-59)
```csharp
    private bool IsReleaseThresholdReached(ProposalInfo proposal, Organization organization)
    {
        var isRejected = IsProposalRejected(proposal, organization);
        if (isRejected)
            return false;

        var isAbstained = IsProposalAbstained(proposal, organization);
        return !isAbstained && CheckEnoughVoteAndApprovals(proposal, organization);
    }

    private bool IsProposalRejected(ProposalInfo proposal, Organization organization)
    {
        var rejectionMemberCount =
            proposal.Rejections.Count(organization.OrganizationMemberList.Contains);
        return rejectionMemberCount > organization.ProposalReleaseThreshold.MaximalRejectionThreshold;
    }

    private bool IsProposalAbstained(ProposalInfo proposal, Organization organization)
    {
        var abstentionMemberCount = proposal.Abstentions.Count(organization.OrganizationMemberList.Contains);
        return abstentionMemberCount > organization.ProposalReleaseThreshold.MaximalAbstentionThreshold;
    }

    private bool CheckEnoughVoteAndApprovals(ProposalInfo proposal, Organization organization)
    {
        var approvedMemberCount = proposal.Approvals.Count(organization.OrganizationMemberList.Contains);
        var isApprovalEnough =
            approvedMemberCount >= organization.ProposalReleaseThreshold.MinimalApprovalThreshold;
        if (!isApprovalEnough)
            return false;

        var isVoteThresholdReached =
            proposal.Abstentions.Concat(proposal.Approvals).Concat(proposal.Rejections).Count() >=
            organization.ProposalReleaseThreshold.MinimalVoteThreshold;
        return isVoteThresholdReached;
    }
```

**File:** contract/AElf.Contracts.Association/Association_Helper.cs (L61-81)
```csharp
    private bool Validate(Organization organization)
    {
        if (organization.ProposerWhiteList.Empty() ||
            organization.ProposerWhiteList.AnyDuplicate() ||
            organization.OrganizationMemberList.Empty() ||
            organization.OrganizationMemberList.AnyDuplicate())
            return false;
        if (organization.OrganizationAddress == null || organization.OrganizationHash == null)
            return false;
        var proposalReleaseThreshold = organization.ProposalReleaseThreshold;
        var organizationMemberCount = organization.OrganizationMemberList.Count();
        return proposalReleaseThreshold.MinimalVoteThreshold <= organizationMemberCount &&
               proposalReleaseThreshold.MinimalApprovalThreshold <= proposalReleaseThreshold.MinimalVoteThreshold &&
               proposalReleaseThreshold.MinimalApprovalThreshold > 0 &&
               proposalReleaseThreshold.MaximalAbstentionThreshold >= 0 &&
               proposalReleaseThreshold.MaximalRejectionThreshold >= 0 &&
               proposalReleaseThreshold.MaximalAbstentionThreshold +
               proposalReleaseThreshold.MinimalApprovalThreshold <= organizationMemberCount &&
               proposalReleaseThreshold.MaximalRejectionThreshold +
               proposalReleaseThreshold.MinimalApprovalThreshold <= organizationMemberCount;
    }
```

**File:** contract/AElf.Contracts.Association/Association.cs (L69-94)
```csharp
    public override Address CreateOrganization(CreateOrganizationInput input)
    {
        var organizationHashAddressPair = CalculateOrganizationHashAddressPair(input);
        var organizationAddress = organizationHashAddressPair.OrganizationAddress;
        var organizationHash = organizationHashAddressPair.OrganizationHash;
        var organization = new Organization
        {
            ProposalReleaseThreshold = input.ProposalReleaseThreshold,
            OrganizationAddress = organizationAddress,
            ProposerWhiteList = input.ProposerWhiteList,
            OrganizationMemberList = input.OrganizationMemberList,
            OrganizationHash = organizationHash,
            CreationToken = input.CreationToken
        };
        Assert(Validate(organization), "Invalid organization.");
        if (State.Organizations[organizationAddress] == null)
        {
            State.Organizations[organizationAddress] = organization;
            Context.Fire(new OrganizationCreated
            {
                OrganizationAddress = organizationAddress
            });
        }

        return organizationAddress;
    }
```

**File:** contract/AElf.Contracts.Association/Association.cs (L203-216)
```csharp
    public override Empty ChangeOrganizationThreshold(ProposalReleaseThreshold input)
    {
        var organization = State.Organizations[Context.Sender];
        Assert(organization != null, "Organization not found.");
        organization.ProposalReleaseThreshold = input;
        Assert(Validate(organization), "Invalid organization.");
        State.Organizations[Context.Sender] = organization;
        Context.Fire(new OrganizationThresholdChanged
        {
            OrganizationAddress = Context.Sender,
            ProposerReleaseThreshold = input
        });
        return new Empty();
    }
```

**File:** test/AElf.Contracts.Association.Tests/AssociationContractTests.cs (L183-328)
```csharp
            var minimalVoteThreshold = 3;
            var maximalAbstentionThreshold = 0;
            var maximalRejectionThreshold = 0;

            var createOrganizationInput = GenerateCreateOrganizationInput(minimalApproveThreshold,
                minimalVoteThreshold,
                maximalAbstentionThreshold, maximalRejectionThreshold, Reviewer1);

            var transactionResult =
                await AssociationContractStub.CreateOrganization.SendWithExceptionAsync(createOrganizationInput);
            transactionResult.TransactionResult.Status.ShouldBe(TransactionResultStatus.Failed);
            transactionResult.TransactionResult.Error.Contains("Invalid organization.").ShouldBeTrue();
        }

        //invalid MinimalApprovalThreshold
        {
            var minimalApproveThreshold = 4;
            var minimalVoteThreshold = 3;
            var maximalAbstentionThreshold = 0;
            var maximalRejectionThreshold = 0;


            var createOrganizationInput = GenerateCreateOrganizationInput(minimalApproveThreshold,
                minimalVoteThreshold,
                maximalAbstentionThreshold, maximalRejectionThreshold, Reviewer1);

            var transactionResult =
                await AssociationContractStub.CreateOrganization.SendWithExceptionAsync(createOrganizationInput);
            transactionResult.TransactionResult.Status.ShouldBe(TransactionResultStatus.Failed);
            transactionResult.TransactionResult.Error.Contains("Invalid organization.").ShouldBeTrue();
        }

        //invalid MinimalApprovalThreshold
        {
            var minimalApproveThreshold = 2;
            var minimalVoteThreshold = 1;
            var maximalAbstentionThreshold = 0;
            var maximalRejectionThreshold = 0;

            var createOrganizationInput = GenerateCreateOrganizationInput(minimalApproveThreshold,
                minimalVoteThreshold,
                maximalAbstentionThreshold, maximalRejectionThreshold, Reviewer1);

            var transactionResult =
                await AssociationContractStub.CreateOrganization.SendWithExceptionAsync(createOrganizationInput);
            transactionResult.TransactionResult.Status.ShouldBe(TransactionResultStatus.Failed);
            transactionResult.TransactionResult.Error.Contains("Invalid organization.").ShouldBeTrue();
        }

        //invalid minimalVoteThreshold
        {
            var minimalApproveThreshold = 1;
            var minimalVoteThreshold = 0;
            var maximalAbstentionThreshold = 0;
            var maximalRejectionThreshold = 0;

            var createOrganizationInput = GenerateCreateOrganizationInput(minimalApproveThreshold,
                minimalVoteThreshold,
                maximalAbstentionThreshold, maximalRejectionThreshold, Reviewer1);
            var transactionResult =
                await AssociationContractStub.CreateOrganization.SendWithExceptionAsync(createOrganizationInput);
            transactionResult.TransactionResult.Status.ShouldBe(TransactionResultStatus.Failed);
            transactionResult.TransactionResult.Error.Contains("Invalid organization.").ShouldBeTrue();
        }

        //invalid maximalAbstentionThreshold
        {
            var minimalApproveThreshold = 1;
            var minimalVoteThreshold = 3;
            var maximalAbstentionThreshold = 4;
            var maximalRejectionThreshold = 0;

            var createOrganizationInput = GenerateCreateOrganizationInput(minimalApproveThreshold,
                minimalVoteThreshold,
                maximalAbstentionThreshold, maximalRejectionThreshold, Reviewer1);
            var transactionResult =
                await AssociationContractStub.CreateOrganization.SendWithExceptionAsync(createOrganizationInput);
            transactionResult.TransactionResult.Status.ShouldBe(TransactionResultStatus.Failed);
            transactionResult.TransactionResult.Error.Contains("Invalid organization.").ShouldBeTrue();
        }

        //invalid minimalVoteThreshold + maximalAbstentionThreshold
        {
            var minimalApproveThreshold = 3;
            var minimalVoteThreshold = 3;
            var maximalAbstentionThreshold = 1;
            var maximalRejectionThreshold = 0;

            var createOrganizationInput = GenerateCreateOrganizationInput(minimalApproveThreshold,
                minimalVoteThreshold,
                maximalAbstentionThreshold, maximalRejectionThreshold, Reviewer1);
            var transactionResult =
                await AssociationContractStub.CreateOrganization.SendWithExceptionAsync(createOrganizationInput);
            transactionResult.TransactionResult.Status.ShouldBe(TransactionResultStatus.Failed);
            transactionResult.TransactionResult.Error.Contains("Invalid organization.").ShouldBeTrue();
        }

        //invalid minimalVoteThreshold + maximalRejectionThreshold
        {
            var minimalApproveThreshold = 3;
            var minimalVoteThreshold = 3;
            var maximalAbstentionThreshold = 0;
            var maximalRejectionThreshold = 1;

            var createOrganizationInput = GenerateCreateOrganizationInput(minimalApproveThreshold,
                minimalVoteThreshold,
                maximalAbstentionThreshold, maximalRejectionThreshold, Reviewer1);
            var transactionResult =
                await AssociationContractStub.CreateOrganization.SendWithExceptionAsync(createOrganizationInput);
            transactionResult.TransactionResult.Status.ShouldBe(TransactionResultStatus.Failed);
            transactionResult.TransactionResult.Error.Contains("Invalid organization.").ShouldBeTrue();
        }

        // empty proposer white list
        {
            var minimalApproveThreshold = 1;
            var minimalVoteThreshold = 2;
            var maximalAbstentionThreshold = 0;
            var maximalRejectionThreshold = 0;

            var createOrganizationInput = GenerateCreateOrganizationInput(minimalApproveThreshold,
                minimalVoteThreshold,
                maximalAbstentionThreshold, maximalRejectionThreshold);
            var transactionResult =
                await AssociationContractStub.CreateOrganization.SendWithExceptionAsync(createOrganizationInput);
            transactionResult.TransactionResult.Status.ShouldBe(TransactionResultStatus.Failed);
            transactionResult.TransactionResult.Error.Contains("Invalid organization.").ShouldBeTrue();
        }

        // empty organization members
        {
            var minimalApproveThreshold = 1;
            var minimalVoteThreshold = 2;
            var maximalAbstentionThreshold = 0;
            var maximalRejectionThreshold = 0;

            var createOrganizationInput = GenerateCreateOrganizationInput(minimalApproveThreshold,
                minimalVoteThreshold,
                maximalAbstentionThreshold, maximalRejectionThreshold, Reviewer1);
            createOrganizationInput.OrganizationMemberList = new OrganizationMemberList();
            var transactionResult =
                await AssociationContractStub.CreateOrganization.SendWithExceptionAsync(createOrganizationInput);
            transactionResult.TransactionResult.Status.ShouldBe(TransactionResultStatus.Failed);
            transactionResult.TransactionResult.Error.Contains("Invalid organization.").ShouldBeTrue();
        }
    }
```

**File:** contract/AElf.Contracts.Parliament/Parliament_Helper.cs (L142-155)
```csharp
    private bool Validate(Organization organization)
    {
        var proposalReleaseThreshold = organization.ProposalReleaseThreshold;

        return proposalReleaseThreshold.MinimalVoteThreshold <= AbstractVoteTotal &&
               proposalReleaseThreshold.MinimalApprovalThreshold <= proposalReleaseThreshold.MinimalVoteThreshold &&
               proposalReleaseThreshold.MinimalApprovalThreshold > 0 &&
               proposalReleaseThreshold.MaximalAbstentionThreshold >= 0 &&
               proposalReleaseThreshold.MaximalRejectionThreshold >= 0 &&
               proposalReleaseThreshold.MaximalAbstentionThreshold +
               proposalReleaseThreshold.MinimalApprovalThreshold <= AbstractVoteTotal &&
               proposalReleaseThreshold.MaximalRejectionThreshold +
               proposalReleaseThreshold.MinimalApprovalThreshold <= AbstractVoteTotal;
    }
```

**File:** contract/AElf.Contracts.Referendum/Referendum_Helper.cs (L90-102)
```csharp
    private bool Validate(Organization organization)
    {
        if (string.IsNullOrEmpty(organization.TokenSymbol) || organization.OrganizationAddress == null ||
            organization.OrganizationHash == null || organization.ProposerWhiteList.Empty())
            return false;
        Assert(!string.IsNullOrEmpty(GetTokenInfo(organization.TokenSymbol).Symbol), "Token not exists.");

        var proposalReleaseThreshold = organization.ProposalReleaseThreshold;
        return proposalReleaseThreshold.MinimalApprovalThreshold <= proposalReleaseThreshold.MinimalVoteThreshold &&
               proposalReleaseThreshold.MinimalApprovalThreshold > 0 &&
               proposalReleaseThreshold.MaximalAbstentionThreshold >= 0 &&
               proposalReleaseThreshold.MaximalRejectionThreshold >= 0;
    }
```
